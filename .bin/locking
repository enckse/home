#!/bin/bash
source $HOME/.bin/common
source $HOME/.bin/subsystem
IS_TRUE=1
IS_FALSE=0
RESULT="RESULT:"
function get-i3lock() {
    pidof i3lock | cut -d " " -f 1
}

function _lock() {
    local p running started slept first
    echo "locking"
    i3lock -c 333333
    for p in $(pidof weechat); do
        kill -10 $p
    done
    toggle-backlighting $BACKLIGHT_OFF
    running=$IS_TRUE
    first=$IS_TRUE
    started=$(date +%s)
    slept=$1
    while [ $running -eq $IS_TRUE ]; do
        sleep 1
        if [ $first -eq $IS_FALSE ]; then
            if [ -z $(get-i3lock) ]; then
                running=$IS_FALSE
            else
                delta=$(date +%s)
                delta=$((delta-started))
                if [ $slept -eq $IS_TRUE ]; then
                    delta=1000
                fi
                if [ $delta -ge 300 ]; then
                    echo "sleeping..."
                    p=$(sleep-now $IS_FALSE | grep "^$RESULT" | sed "s/$RESULT//g")
                    if [ $p -eq $IS_TRUE ]; then
                        started=$(date +%s)
                        slept=$IS_FALSE
                    fi
                fi
            fi
        fi
        first=$IS_FALSE
    done
    toggle-backlighting $MID_BRIGHT
}

function _autolock() {
    local waiting
    lock-now $IS_TRUE &
    sleep 1
    waiting=$IS_TRUE
    while [ $waiting -eq $IS_TRUE ]; do
        if [ -z $(get-i3lock) ]; then
            waiting=$IS_FALSE
            break
        fi
        sleep 1
    done
}

function _sleeping() {
    mute
    pkill vlc
    echo "suspending"
    systemctl suspend
    echo "done sleeping"
    wsw reload
}

function sleep-now() {
    local auto
    auto=$1
    if [ -e $DISPLAY_EN ]; then
        echo "nosleep"
        echo "$RESULT$IS_FALSE"
    else
        if [ $auto -eq $IS_TRUE ]; then
            _autolock
            echo "$RESULT$IS_FALSE"
        else
            _sleeping
            echo "$RESULT$IS_TRUE"
        fi
    fi
}

function lock-now() {
    if [ -e $DISPLAY_UN ]; then
        echo "nolock"
    else
        if [ -z $(get-i3lock) ]; then
            _lock $1
        fi
    fi
}

function toggle() {
    local no_action
    no_action=0
    if [ -e $DISPLAY_UN ]; then
        rm $DISPLAY_UN
        touch $DISPLAY_EN
        no_action=1
    fi

    if [ $no_action -eq 0 ]; then
        if [ -e $DISPLAY_EN ]; then
            rm $DISPLAY_EN
            no_action=1
        fi
    fi

    if [ $no_action -eq 0 ]; then
        touch $DISPLAY_UN
    fi
}

function locking() {
    case $1 in
        "toggle")
            toggle
            ;;
        "lock")
            lock-now $IS_FALSE
            ;;
        "sleep")
            sleep-now $IS_TRUE
            ;;
    esac
}

locking "$1"
