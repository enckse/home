CRYPT_MNT=/mnt/crypt
TMP=/var/tmp/crypt.img

function add-keys()
{
    keys=$(find $CRYPT_MNT/ssh/**/* -type f)
    for key in $keys; do
        ssh-add -l | grep -qE "$key"
        if [ $? -ne 0 ]; then
            echo "adding $key"
            ssh-add $key
        fi
    done
}

mount | grep -q $CRYPT_MNT
if [ $? -eq 0 ]; then
    echo "already mounted"
else
    rsync -vrziut /mnt/Synced/crypt.img $TMP
    sudo cryptsetup luksOpen --readonly $TMP crypt-img
    sudo mkdir -p $CRYPT_MNT
    sudo mount /dev/mapper/crypt-img $CRYPT_MNT
fi
add-keys
