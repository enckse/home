#!/bin/bash
LOCATION=/var/lib/machines/
TEMPLATE="new"
CONFIG=".template"
TEMPLATE_PATH=${LOCATION}$TEMPLATE
TEMPLATE_CONF=$TEMPLATE_PATH$CONFIG
ETC_NSPAWN=/etc/systemd/nspawn/
SPAWN_KEY="spawn"
REM_KEY="remove"
PACK_KEY="pack"

function print-help()
{
    echo "
    $SPAWN_KEY (create a new container)
    $REM_KEY (force remove a container)
    $PACK_KEY (pack a container)
"
}

if [ $UID -ne 0 ]; then
    if [ -z "$1" ]; then
        print-help
    else
        echo "must be run as root..."
    fi
    exit -1
fi

mkdir -p $ETC_NSPAWN
if [ -z "$1" ]; then
    echo "action required..."
    exit -1
fi

if [ -z "$2" ]; then
    echo "name required..."
    exit -1
fi

CONT_PATH=${LOCATION}$2
CONT_CONF=$ETC_NSPAWN$2".nspawn"

function is-running()
{
    machinectl status $1 &> /dev/null
    if [ $? -eq 0 ]; then
        echo "$1 is running..."
        exit -1
    fi
}

function spawn()
{
    if [ ! -e $TEMPLATE_CONF ]; then
        echo "$TEMPLATE_CONF is required..."
        exit -1
    fi

    if [ ! -d "$TEMPLATE_PATH" ]; then
        echo "$TEMPLATE_PATH must be a pacstrap container..."
        exit -1
    fi


    if [ -d $CONT_PATH ] || [ -e $CONT_CONF ]; then
        echo "$1 already exists..."
        exit -1
    fi

    is-running $TEMPLATE
    NEW_BASIS_TEMPLATE=$ETC_NSPAWN${TEMPLATE}.nspawn
    if [ ! -e $NEW_BASIS_TEMPLATE ]; then
        ln -s $TEMPLATE_CONF $NEW_BASIS_TEMPLATE
    fi

    echo "copying data...($CONT_PATH)"
    cp -R $TEMPLATE_PATH $CONT_PATH
    echo "and config...($CONT_CONF)" 
    cp $TEMPLATE_CONF $CONT_CONF
}

function pack()
{
    is-running $1
    if [ ! -d $CONT_PATH ]; then
        echo "not a valid container..."
        exit -1
    fi
    SAVE_TO=$PWD
    echo $SAVE_TO/pack.tar.gz
    cd $LOCATION
    tar -czvpf $SAVE_TO/pack.tar.gz --one-file-system "$1/"
    cd $SAVE_TO
}

function remove()
{
    is-running $1
    if [ -d $CONT_PATH ]; then
        rm -rf $CONT_PATH
    fi

    if [ -e $CONT_CONF ]; then
        rm -f $CONT_CONF
    fi
}

case $1 in
    $SPAWN_KEY)
        spawn $2
        ;;
    $REM_KEY)
        remove $2
        ;;
    $PACK_KEY)
        pack $2
        ;;
    *)
        print-help
        ;;
esac
