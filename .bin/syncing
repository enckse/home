#!/bin/bash
source $HOME/.bin/common

function do-segment()
{
    echo "### $1 ###"
}

function test-ssh()
{
    running=$(ssh -o BatchMode=yes -o ConnectTimeout=5 $1 echo $READY 2>&1)
    if [[ "$running" == "$READY" ]]; then
        echo $IS_CONNECTED
    else
        echo $NOT_CONNECTED
    fi
}

function sync-now()
{
    SYNC_TO="sync"
    auth=$(cat $SSH_AUTH_TMP)
    export SSH_AUTH_SOCK=$auth
    available=$(test-ssh "$SYNC_TO")
    echo "====================="
    echo "running "$(date +%Y-%m-%dT%H:%M:%S)
    echo "====================="
    if [ ! -d $SSH_KEY_PATH ]; then
        echo "$SSH_KEY_PATH not mounted..."
        exit -1
    fi
    echo "checked for connection...$available"
    if [ $available -eq $IS_CONNECTED ]; then
        do-segment "fetch"
        rsync -avzc -e ssh $SYNC_TO:~/Host/ $HOME/.cache/hosted/
        do-segment "git"
        if [ -e $SSH_AUTH_TMP ]; then
            current=$PWD
            cd ${SYNCED_PATH}
            git push 2>&1
            cd $current
        else
            echo "ssh agent unavailable"
        fi
        do-segment "sync"
        rsync -avzc --exclude "*.lock" --exclude ".gitignore" --exclude "*/" --delete-after ${SYNCED_PATH} -e ssh $SYNC_TO:~/Sync/
        touch $USER_LAST_SYNC
    fi
}

sync-now | systemd-cat -t "sync"
