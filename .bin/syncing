#!/bin/bash
source $HOME/.bin/common
PROFILE_PATH=/mnt/Storage/Active/Rolling/profiles
ARCHIVE=$USER_TMP/profile.7z
SPACING="    "
SSH_AUTH_TMP=/tmp/ssh-auth.sock

function backup()
{
    today=$(date +%Y-%m-%d)
    backup=$PROFILE_TMP$today
    if [ ! -e $backup ]; then
        if [ ! -e $ARCHIVE ]; then
            echo "zipping archive"
            7z a -t7z -bd $ARCHIVE $HOME/.cache/scratch/ $HOME/.mozilla/ &>/dev/null
            echo "zip completed: $?"
        fi
        echo "${SPACING}pushing profile out"
        scp $ARCHIVE $BASE_SERVER:$PROFILE_PATH/mobile.$today.7z
        ssh $BASE_SERVER "find $PROFILE_PATH -type f -mtime +7 -exec rm {} \;"
        rm -f $ARCHIVE
        touch $backup
    fi
}
    
function sync-now()
{
    local dirs
    auth=$(cat $SSH_AUTH_TMP)
    export SSH_AUTH_SOCK=$auth
    available=$(test-ssh $BASE_SERVER)
    echo "====================="
    echo "running "$(date +%Y-%m-%dT%H:%M:%S)
    echo "====================="
    echo "checked for connection...$available"
    if [ $available -eq $IS_CONNECTED ]; then
        if [ -e $SSH_AUTH_TMP ]; then
            echo "syncing..."
            dirs=$(ls ${PERM_LOCATION} | grep $PERM_PERSONAL | sed "s#^#$PERM_LOCATION#g")
            dirs="$dirs ${SYNCED_PATH} /etc"
            for d in $(echo $dirs); do
                echo "$d"
                git -C "$d" push 2>&1 | sed "s/^/$SPACING/g"
            done
            echo "daily backup"
            backup
            update-stat $USER_SYNC
        else
            echo "ssh agent unavailable"
        fi
    fi
}

sync-now | systemd-cat -t "sync"
