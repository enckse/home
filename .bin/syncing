#!/bin/bash
source $HOME/.bin/common
PROFILE_PATH=/mnt/Storage/Active/Rolling/profiles
ARCHIVE=$USER_TMP/profile.7z
SPACING="    "

function backup()
{
    today=$(date +%Y-%m-%d)
    backup=$PROFILE_TMP$today
    if [ ! -e $backup ]; then
        zip-now
        echo "${SPACING}pushing profile out"
        scp $ARCHIVE $BASE_SERVER:$PROFILE_PATH/mobile.$today.7z
        ssh $BASE_SERVER "find $PROFILE_PATH -type f -mtime +7 -exec rm {} \;"
        rm -f $ARCHIVE
        touch $backup
    fi
}
    
function zip-now()
{
    if [ ! -e $ARCHIVE ]; then
        echo "${SPACING}zipping profile(s)"
        7z a -t7z -bd $ARCHIVE $HOME/.cache/scratch/ $HOME/.mozilla/ &>/dev/null
        echo "${SPACING}zip done: $?"
    fi
}

function sync-now()
{
    auth=$(cat $SSH_AUTH_TMP)
    export SSH_AUTH_SOCK=$auth
    available=$(test-ssh $BASE_SERVER)
    echo "====================="
    echo "running "$(date +%Y-%m-%dT%H:%M:%S)
    echo "====================="
    zip-now
    echo "checked for connection...$available"
    if [ $available -eq $IS_CONNECTED ]; then
        if [ -e $SSH_AUTH_TMP ]; then
            echo "git push"
            current=$PWD
            cd ${SYNCED_PATH}
            git push 2>&1
            for personal in $(ls ${PERM_LOCATION} | grep $PERM_PERSONAL); do
                echo "${SPACING}pushing $personal"
                cd ${PERM_LOCATION}/$personal
                git push 2>&1 | sed "s/^/$SPACING/g"
            done
            echo "/etc"
            cd /etc
            git push 2>&1
            cd $current
            echo "daily backup"
            backup
        else
            echo "ssh agent unavailable"
        fi
        update-time "user-sync"
    fi
}

sync-now | systemd-cat -t "sync"
