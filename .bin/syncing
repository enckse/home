#!/bin/bash
source $HOME/.bin/common
source $HOME/.bin/install-git-common
PID_FILE="$USER_TMP/syncing.pid"
SLEEP_FOR=5
ROTATION_COUNT=120
SERVICE_NAME="syncing@enck.service"
SERVICE_FILE="$HOME/.bin/sys/$SERVICE_NAME"

function start-syncing()
{
    PID=$RANDOM
    echo $PID > $PID_FILE
    IS_READY="ok"
    SYNC_TO="sync"
    echo "Running as $PID"
    ROTATE_COUNT=0
    while [ -e $PID_FILE ]; do
        touch $PID_FILE
        CURRENT_PID=$(cat $PID_FILE)
        if [[ "$CURRENT_PID" != "$PID" ]]; then
            echo "$CURRENT_PID is active sync process (not $PID)"
            exit -1
        fi
        if [ $ROTATE_COUNT -eq 0 ]; then
            available=$(ssh -o BatchMode=yes -o ConnectTimeout=5 $SYNC_TO echo $IS_READY 2>&1)
            echo "====================="
            echo "running ($PID) "$(date +%Y-%m-%dT%H:%M:%S)
            echo "====================="
            echo "checked for connection...$available"
            if [[ "$available" == "$IS_READY" ]]; then
                rsync -avzc --delete-after /mnt/Synced/ -e ssh $SYNC_TO:~/Sync/
            fi
        fi
        sleep $SLEEP_FOR
        ROTATE_COUNT=$((ROTATE_COUNT+1))
        if [ $ROTATE_COUNT -gt $ROTATION_COUNT ]; then
            ROTATE_COUNT=0
        fi
    done
}

function stop-syncing()
{
    if [ -e $PID_FILE ]; then
        rm $PID_FILE
    fi
}

case $1 in
    $INSTALL_KEYWORD)
        sudo systemctl enable $SERVICE_FILE
        sudo ln -s $HOME/.bin/syncing /usr/local/bin/
        ;;
    $REMOVE_KEYWORD)
        sudo systemctl disable $SERVICE_NAME
        sudo rm /usr/local/bin/syncing
        ;;
    "start")
        start-syncing
        ;;
    "stop")
        stop-syncing
        ;;
    *)
        echo "unknown command: $1"
        ;;
esac
