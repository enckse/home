#!/bin/bash
MY_HOME=/home/enck/
source ${MY_HOME}.bin/common
CONF_HOME=${HOME_CONF}home
PKG_QUERY=$USER_TMP/package.query
PACKAGE_SET=${CONF_HOME}/packages
WEECHAT_PLUGINS=${USER_TMP}/weechat.plugins
PKGBUILD_CHECKS=${USER_TMP}/pkgbuild.checks
PACKAGE_GROUPS="
xorg
base-devel
"
BOOTED=/tmp/user.booted-$(uptime -s | sed "s/ /-/g;s/:/-/g")
hourly_check=$USER_TMP/.maintain.hourly.$(date +%Y-%m-%d-%H)
if [ ! -e $BOOTED ]; then
    echo "booting up..."
    rm -f $hourly_check
    files=""
    for f in $(echo "wget-hsts python_history esd_auth lesshst"); do
        fname=${MY_HOME}$f
        files="$files $fname"
    done
    files="$files "$(find $USER_TMP -type f | grep "${PROFILE_TMP}")
    for f in $(echo "$files"); do
        if [ -e "$f" ]; then
            echo "deleting temp file: $f"
            rm -f "$f"
        fi
    done
    touch $BOOTED
fi

function weechat-logs() {
    local logs running f fname p tmpfile
    logs=$USER_TMP/weechat/
    mkdir -p $logs
    running=$(pidof weechat)
    if [ -z "$running" ]; then
        echo "cleaning up weechat logs"
        for f in $(find $HOME/.weechat/logs/ -type f); do
            fname=${logs}$(basename $f)
            cat $f | grep -v -E "^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9] [0-9][0-9]:[0-9][0-9]:[0-9][0-9][[:space:]]+(<|-)-" > $fname
            cp $f $fname.$(date +%s)
            mv $fname $f
        done
        if [ ! -e $WEECHAT_PLUGINS ]; then
            touch $WEECHAT_PLUGINS
            echo "downloading latest scripts"
            for p in $(echo "buffer_autoset autosort"); do
                tmpfile=$USER_TMP/$p.py
                curl -s https://www.weechat.org/files/scripts/$p.py > $tmpfile
                if [ ! -s "$tmpfile" ]; then
                    continue
                fi
                diff -u $MY_HOME/.weechat/python/$p.py $tmpfile > /dev/null
                if [ $? -ne 0 ]; then
                    echo "$p weechat plugin updated ($tmpfile)" | systemd-cat -p err -t maintain
                fi
            done
        fi
    fi
}

function last-done() {
    local found d f s
    found=0
    for s in $(seq 0 6); do
        d=$(date -d "$s days ago" +%Y-%m-%d)
        f=$1.$d
        if [ -e $f ]; then
            touch $f
            found=1
            break
        fi
    done
    if [ $found -eq 0 ]; then
        echo "missing: $1"
    fi
}

function set-user-files() {
    local f v running vim_dir
    echo "set user files"

    # user tmp
    mkdir -p $USER_TMP
    find $USER_TMP* -mtime 1 -type f -exec rm {} \;
    find $USER_TMP -empty -type d -delete

    for f in $(find $USER_TMP -type f -mmin +30 | grep "dmenu"); do
        rm -f $f
    done

    # vim
    for v in $(echo "undo swap"); do
        vim_dir=$HOME/.vim/$v
        mkdir -p $vim_dir
        find $vim_dir -mmin +1440 -type f -exec rm {} \;
    done
    
    # packages
    if [ ! -e $PKG_QUERY ]; then
        running=$(pidof pacman)
        if [ -z "$running" ]; then
            /usr/bin/pacman -Qqe > $PACKAGE_SET
            echo "$PACKAGE_GROUPS" >> $PACKAGE_SET
            touch $PKG_QUERY
        fi
    fi
}

function process-logs() {
    echo "checking pacman status"
    pacman-check | systemd-cat -p err -t "maintain"
}

function outdated() {
    local d weekago
    d=$(date -d "$1" +%s)
    weekago=$(date -d "1 week ago" +%s)
    if [ $d -lt $weekago ]; then
        echo "outdated? $2 ($1)"
    fi
}

function check-pacman-update() {
    local d f
    f=$1/var/log/pacman.log
    d=$(cat $f | grep $(date +%Y) | cut -d " " -f 1 | cut -d "[" -f 2 | sort | uniq | tail -n 1)
    outdated "$d" "$f"
}

function pacman-check() {
    check-pacman-update ""
    check-pacman-update "$CHROOT_LOCATION/root"
}

function daily() {
    local f xsess
    f=$USER_TMP/maintain.$(date +%Y-%m-%d)
    if [ ! -e $f ]; then
        touch $f
        echo "running daily checks..."
        xsess=$HOME/.xsession-errors
        if [ -e $xsess ]; then
            cat $xsess >> $USER_TMP/xsession.$(date +%Y-%m-%d)
            rm -f $xsess
        fi
        process-logs
        check-syncing
    fi
}

function check-syncing() {
    journalctl -t sync --since "7 days ago" | grep -q "local sync completed"
    if [ $? -ne 0 ]; then
        echo "no reset successful syncs" | systemd-cat -p err -t "maintain"
    fi
}

function pkgbuilds() {
    local f name repo fname tmpname
        for f in $(cat ${HOME_PERSONAL}pkgbuilds.csv); do
            name=$(echo "$f" | cut -d "," -f 1)
            fname="${USER_TMP}/.pkgbuild.$name"
            touch $fname
    if [ ! -e "$PKGBUILD_CHECKS" ]; then
            repo=$(echo "$f" | cut -d "," -f 2)
            case $repo in
                "extra")
                    repo="https://git.archlinux.org/svntogit/packages.git/plain/trunk/PKGBUILD?h=packages/$name"
                    ;;
                "community")
                    repo="https://git.archlinux.org/svntogit/community.git/plain/trunk/PKGBUILD?h=packages/$name"
                    ;;
                *)
                    echo "unknown repo: $repo"
                    ;;
            esac
            tmpname="$fname.tmp"
            curl -s "$repo" > $tmpname
            if [ $? -eq 0 ]; then
                if [ -e "$fname" ]; then
                    diff -u $fname $tmpname
                    if [ $? -ne 0 ]; then
                        echo "$f has been updated, rebuild?" | systemd-cat -p err -t "pkgbuilds"
                    fi
                fi
            fi
            mv $tmpname $fname
        touch $PKGBUILD_CHECKS
    fi
        done
}

if [ ! -e $hourly_check ]; then
    weechat-logs
    set-user-files
    daily
    pkgbuilds
    touch $hourly_check
fi
