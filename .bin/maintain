#!/bin/bash
source /home/enck/.bin/common
CONF_HOME=${HOME_CONF}home
PACKAGE_SET=${CONF_HOME}/packages

_booting() {
    echo "booting up..."
    # cleanup file
    rm -f $HOME/.python_history*
    rm -f $HOME/.wget-hsts*
    rm -f $HOME/.esd_auth*
    rm -f $HOME/.lesshst*
    rm -f $PROFILE_TMP*
    rm -f $SYS_ONLINE
    
    # packages
    /usr/bin/pacman -Qqe > $PACKAGE_SET

    # mail validation
    find $MAIL_DIR -type f -exec file {} \; | grep -v "\.notmuch\/" | grep -v -E "(ASCII|UTF-8 Unicode|ISO-8859) text(,|$)" | systemd-cat -t "mailsync" -p err

    wsw reload
}

daily() {
    local f xsess
    f=$USER_TMP/maintain.$(date +%Y-%m-%d)
    if [ ! -e $f ]; then
        echo "running daily checks..."
        xsess=$HOME/.xsession-errors
        if [ -e $xsess ]; then
            cat $xsess >> $USER_TMP/xsession.$(date +%Y-%m-%d)
            rm -f $xsess
        fi
        echo "clearing user tmp..."
        mkdir -p $USER_TMP
        find $USER_TMP* -mtime 1 -type f -exec rm {} \;
        find $USER_TMP -empty -type d -delete
        find $HOME/.vim/{swap,undo} -mmin +1440 -type f -exec rm {} \;
        echo "validate syncing"
        journalctl -t sync --since "7 days ago" | grep -q "local sync completed"
        if [ $? -ne 0 ]; then
            echo "no reset successful syncs" | systemd-cat -p err -t "maintain"
        fi
    fi
}

if [ -z "$1" ]; then
    daily
else
    if [[ "$1" == "boot" ]]; then
        _booting
    fi
fi
