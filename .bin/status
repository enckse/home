#!/bin/bash
source $HOME/.bin/common
FULL="$HOME/.config/genericon/"
DELIMIT="|"
LOCKING_KEY=$STATUS_LOCKING_KEY
BACKLIGHT_KEY=$STATUS_BACKLIGHT_KEY
PING_KEY=$STATUS_PING_KEY

function output-full()
{
    img=$(echo $1 | cut -d "$DELIMIT" -f 1)
    res=${FULL}$img.png
    echo "$1" | grep -q "$DELIMIT"
    if [ $? -eq 0 ]; then
        tip=$(echo $1 | cut -d "$DELIMIT" -f 2)
    fi
    json='{"path": "'$res'"'
    if [ ! -z $tip ]; then
        json=$json', "tooltip": "'$tip'"'
    fi 
    echo $json'}'
}

function get-brightness()
{
    xrandr --current --verbose | grep "Brightness" | cut -d ":" -f 2 | sed "s/0\.//g" | sed "s/1\.0/100/g" | tail -n 1 | awk '{printf "%3.0f", $1}' | sed "s/^[ \t]*//g"
}

function backlight-status()
{
    brightness=$(get-brightness)
    IMAGE="unknown"
    if [ $brightness -gt 95 ]; then
        IMAGE="high"
    else
        if [ $brightness -gt 30 ]; then
            IMAGE="mid"
        else
            IMAGE="low"
        fi
    fi
    echo $IMAGE"-bright"${DELIMIT}$brightness
}

function locking-status()
{
    if [ -e $DISPLAY_UN ]; then
        echo "unlocked"
    else
        if [ -e $DISPLAY_EN ]; then
            echo "running"
        else
            echo "display"
        fi
    fi
}

function ping-status()
{
    raw=$(ping -c 1 www.google.com -4 2>/dev/null)
    avg=""
    unt=""
    echo $raw | grep -q "100% packet loss"
    if [ $? -eq 0 ]; then
        raw=""
    fi
    if [ ! -z "$raw" ]; then
        avg=$(echo "$raw" | tail -1 | awk '{print $4}' | cut -d '/' -f 2 | cut -d "." -f 1)
        unt=$(echo "$raw" | tail -1 | cut -d " " -f 5)
    fi
    val="unknown"
    if [ ! -z "$avg" ]; then
        if [ $avg -lt 250 ]; then
            if [[ "$unt" != "received,"] ]]; then
                val="low"
            else
                avg="unknown"
            fi
        else
            val="high"
        fi
    fi
    if [ -z "$avg" ]; then
        avg="disconnected"
    fi
    echo ${val}"-ping"${DELIMIT}$avg$unt
}

function init-now()
{
    refreshing=$DEFAULT_REFRESH
    if [ ! -z "$1" ]; then
        refreshing=$1
    fi
   
    python $HOME/.bin/modules/genericon/genericon.py -c $SYNCED_CONF/genericon.config
    sleep 0.25 
    signal-status "$LOCKING_KEY"
    call-status $LOCKING_KEY
}

case $1 in
    $LOCKING_KEY)
        cmd=locking-status
        ;;
    $BACKLIGHT_KEY)
        cmd=backlight-status
        ;;
    $PING_KEY)
        cmd=ping-status
        ;;
    "init")
        init-now "$2"
        ;;
esac

if [ ! -z $cmd ]; then
    result=$($cmd)
    output-full $result
fi
