#!/bin/bash
CRYPT_MNT=/mnt/crypt
TMP=/var/tmp/crypt.img
MNT_SHARE=/mnt/Storage
IS_MOUNTED=1
USB_KEYWORD="usb"
SHARE_KEYWORD="shares"
CRYPT_KEYWORD="crypt"
UCRYPT_KEYWORD="ucrypt"
KEYS_KEYWORD="keys"
UMNT_KEYWORD="umount"
MAPPER_NAME="crypt-img"
DEFCRYPT_KEYWORD="defcrypt"
REMCRYPT_KEYWORD="remcrypt"
NEWMOUNTS="/tmp/"
SETUP_CRYPT="setup"
function add-keys()
{
    IS_MNT=$(is-mounted $CRYPT_MNT)
    if [ $IS_MNT -eq $IS_MOUNTED ]; then
        keys=$(find $CRYPT_MNT/ssh/**/* -type f)
        for key in $keys; do
            ssh-add -l | grep -qE "$key"
            if [ $? -ne 0 ]; then
                echo "adding $key"
                ssh-add $key
            fi
        done
    else
        echo "keys not available"
        exit -1
    fi
}

function is-mounted()
{
    mount | grep -q $1
    if [ $? -eq 0 ]; then
        echo $IS_MOUNTED
    else
        echo 0
    fi
}

function print-help()
{
    echo
    echo "  $SHARE_KEYWORD - mount local share(s)"
    echo "  $UMNT_KEYWORD - umount local share(s)"
    echo "  $CRYPT_KEYWORD - mount encrypted file image(s)"
    echo "  $UCRYPT_KEYWORD - umount encrypted file image(s)"
    echo "  $KEYS_KEYWORD - load ssh keys from crypt"
    echo "  $USB_KEYWORD - mount a usb drive"
    echo "  $DEFCRYPT_KEYWORD - define a new crypt (optional size)"
    echo "  $REMCRYPT_KEYWORD - remove a crypt (required path to crypt)"
    echo
}

function mount-crypt()
{
    IS_MNT=$(is-mounted $CRYPT_MNT)
    if [ $IS_MNT -eq $IS_MOUNTED ]; then
        echo "already mounted"
        exit -1
    fi

    rsync -vrziut /mnt/Synced/crypt.img $TMP
    open-crypt "--readonly" "$TMP" "$MAPPER_NAME" "$CRYPT_MNT" "open"
}

function rem-crypt()
{
    if [ -z $2 ]; then
        echo "requires an object to remove/cleanup"
        exit -1
    fi
    IS_MNT=$(is-mounted $2)
    if [ $IS_MNT -ne $IS_MOUNTED ]; then
        echo "not mounted"
        exit -1
    fi

    use_mapper=$3
    if [ -z $use_mapper ]; then
        use_mapper=$(basename $2)
    fi

    close-crypt $2 $use_mapper    
}

function def-crypt()
{
    size=$2
    MAPPING=$(uuidgen)"-crypt-mapper"
    if [ -z $size ]; then
        size="5M"
    fi

    check_size=$(echo "$size" | grep "^[0-9][0-9]*" | grep -E "M|G")
    if [ -z "$check_size" ]; then
        echo "invalid size: $size"
        exit -1
    fi

    file_name=$PWD/$MAPPING".img"
    DEF_MOUNT=${NEWMOUNTS}$MAPPING

    echo "
creating file $file_name ($size)
mounting: $DEF_MOUNT
mapper: $MAPPING
"
    read -p "continue (y/n)? " yn
    if [[ $yn == "y" ]]; then
        dd if=/dev/zero of=$file_name bs=1 count=0 seek=$size
        sudo cryptsetup luksFormat $file_name
        open-crypt "" "$file_name" "$MAPPING" "$DEF_MOUNT" "$SETUP_CRYPT"
        df -h $DEF_MOUNT
    fi
}

function open-crypt()
{
    sudo cryptsetup luksOpen $1 $2 $3
    sudo mkdir -p $4
    if [[ "$5" == "$SETUP_CRYPT" ]]; then
        sudo mkfs.ext4 /dev/mapper/$3
    fi
    sudo mount /dev/mapper/$3 $4
    if [[ "$5" == "$SETUP_CRYPT" ]]; then
        sudo chown -R enck:enck $4
    fi
}

function close-crypt()
{
    sudo umount $1
    sudo cryptsetup luksClose $2
}

function umount-crypt()
{
    rem-crypt "" "$CRYPT_MNT" "$MAPPER_NAME"
}

function mount-usb()
{
    sudo fdisk -l | grep "Disk /dev/" | cut -d ' ' -f 2,3,4 | cut -d ',' -f 1
    echo "Select drive:"
    read USBDISK
    USBDISK+="1"
    sudo mount $USBDISK /mnt/usb
}

function mount-share()
{
    IS_MNT=$(is-mounted $MNT_SHARE)
    if [ $IS_MNT -eq $IS_MOUNTED ]; then
        echo "already mounted"
        exit -1
    fi
    sudo mount base:$MNT_SHARE $MNT_SHARE
}

function umount-share()
{
    IS_MNT=$(is-mounted $MNT_SHARE)
    if [ $IS_MNT -eq $IS_MOUNTED ]; then
        sudo umount $MNT_SHARE
    fi    
}

case $1 in
    $SHARE_KEYWORD)
        mount-share
        ;;
    $UMNT_KEYWORD)
        umount-share
        ;;
    $CRYPT_KEYWORD)
        mount-crypt
        add-keys
        ;;
    $UCRYPT_KEYWORD)
        umount-crypt
        ;;
    $KEYS_KEYWORD)
        add-keys
        ;;
    $USB_KEYWORD)
        mount-usb
        ;;
    $DEFCRYPT_KEYWORD)
        def-crypt $@
        ;;
    $REMCRYPT_KEYWORD)
        rem-crypt $@
        ;;
    *)
        print-help
        ;;
esac
