#!/bin/bash
source $HOME/.bin/common
INDEX_DIR=$MAIL_DIR/Indexed/
INDEXED=${INDEX_DIR}cur/
INDEX_FILE=$USER_TMP/mail.index
ACCOUNTS="fastmail gmail"
MUTTHTML="$USER_TMP/*.mutt.html"

_mailcount() {
    local cnt d results first
    first=1
    for d in $(echo "$ACCOUNTS"); do
        cnt=$(find $MAIL_DIR/$d -type f | grep "/new/" | grep -v "/Trash/" | wc -l)
        if [ $cnt -gt 0 ]; then
            if [ $first -eq 1 ]; then
                first=0
            else
                results="$results "
            fi
            results="$results$cnt $d"
        fi
    done
    echo "$results"
}

_mbsync() {
    local pids purge last now a logfile ts
    pids=$(pidof mbsync)
    if [ -z "$pids" ]; then
        mkdir -p $INDEXED
        mkdir -p ${INDEX_DIR}new
        purge=1
        if [ -e $INDEX_FILE ]; then
            last=$(cat $INDEX_FILE)
            now=$(date -d "15 minutes ago" +%s)
            if [ $last -gt $now ]; then
                purge=0
            fi
        fi
        >&2 echo "purging index: $purge"
        if [ $purge -eq 1 ]; then
            rm -f ${INDEXED}*
        fi
        logfile=$USER_TMP/.mbsync.$(date +%Y-%m-%d).log 
        ts=$(date +%Y-%m-%dT%H:%M:%S)
        mbsync -aV | sed "s/^/$ts -> /g" >> $logfile
        if [ $? -ne 0 ]; then
            echo "mbsync failure" | systemd-cat -p err -t "mbsync"
        fi
        notmuch new
    else
        >&2 echo "mbsync already running ($pids)"
    fi
}

_imapjournal() {
    if [ -e $SYS_ONLINE ]; then
        _mbsync 2>&1 | systemd-cat -t "mailsync"
    fi
}

_search() {
    date +%s > $INDEX_FILE
    rm -f ${INDEXED}*
    notmuch search --output=files $@ | sed -e 's: :\\\\ :g' | xargs -r -I searchoutput ln -s searchoutput $INDEXED
}

if [ -z "$1" ]; then
    _imapjournal
else
    case "$1" in
        "client")
            if [ -z "$2" ]; then
                echo "account required"
                exit 1
            fi
            touch $TRIGGER_EMAIL
            sleep 0.5
            cd $HOME/Downloads
            mutt -F $HOME/.mutt/$2.muttrc
            sleep 0.25
            ;;
        "search")
            _search ${@:2}
            ;;
        "count")
            _mailcount
            ;;
        *)
            echo "unknown command: $1"
            ;;
    esac
fi
