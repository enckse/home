#!/bin/bash
source $HOME/.bin/common
_mailsync() {
    local process cnt last now
    now=$USER_TMP/mailstatus.current
    process=0
    source $PRIV_CONF
    for f in $(cat ${HOME_PERSONAL}.muttrc | sed "s/^mailboxes //g" | sed "s/+//g"); do
        cnt=$(find $HOME/.mutt/imap/$f/new -type f | wc -l)
        process=$((process+cnt))
    done
    if [ -e $now ]; then
        last=$(cat $now)
        if [ $process -gt $last ]; then
            notmuch new
            notify-send Mail "unread messages ($process)"
        fi
    fi
    echo "$process" > $now
    cp $now $MAIL_COUNT
}

_offlineimap() {
    local pids
    pids=$(pidof -x offlineimap)
    if [ -z "$pids" ]; then
        offlineimap -c ${SYNCED_PATH}mail/imap.conf
        _mailsync
    else
        echo "offlineimap already running ($pids)"
    fi
}

_webview() {
    local htmls f ready
    for f in $(find $USER_TMP/html/ -type f); do
        ready=$USER_TMP/.webview.$(basename $f).done
        mv $f $ready
        htmls="$htmls $ready"
    done
    firefox $htmls &
}

if [ -z "$1" ]; then
    _offlineimap
else
    if [[ "$1" == "client" ]]; then
        _offlineimap 2>/dev/null &
        sleep 0.5
        cd $HOME/Downloads
        mutt
    else
        if [[ "$1" == "webview" ]]; then
            _webview
        else
            echo "unknown command: $1"
        fi
    fi
fi
