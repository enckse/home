#!/bin/bash
source $HOME/.bin/common
INDEX_DIR=$MAIL_DIR/Indexed/
INDEXED=${INDEX_DIR}cur/
INDEX_FILE=$USER_TMP/mail.index
MAIL_CONFIG=${PERM_CONFIGS}mail/
ACCOUNTS="fastmail gmail"
MUTTHTML="$USER_TMP/*.mutt.html"

_mailcount() {
    local process cnt folders f d
    source $PRIV_CONF
    folders=""
    process=0
    for d in $(echo "$ACCOUNTS"); do
        for f in $(cat ${MAIL_CONFIG}$d.muttrc | sed "s/^mailboxes //g" | sed "s/+//g" | sort); do
            cnt=$(find $MAIL_DIR/$d/$f/new -type f | wc -l)
            process=$((process+cnt))
            if [ $cnt -gt 0 ]; then
                folders="$folders $d:$f"
            fi
        done
    done
    echo "$process$folders"
}

_mailsync() {
    local process last now f cnt
    now=$USER_TMP/mailstatus.current
    process=$(_mailcount)
    cnt=$(echo "$process" | cut -d " " -f 1)
    if [ -e $now ]; then
        last=$(cat $now)
        if [ $cnt -gt $last ]; then
            notmuch new
            notify-send Mail "unread messages ($process)"
        fi
    fi
    echo "$cnt" > $now
}

_mbsync() {
    local pids purge last now a
    pids=$(pidof mbsync)
    if [ -z "$pids" ]; then
        mkdir -p $INDEXED
        mkdir -p ${INDEX_DIR}new
        purge=1
        if [ -e $INDEX_FILE ]; then
            last=$(cat $INDEX_FILE)
            now=$(date -d "15 minutes ago" +%s)
            if [ $last -gt $now ]; then
                purge=0
            fi
        fi
        >&2 echo "purging index: $purge"
        if [ $purge -eq 1 ]; then
            rm -f ${INDEXED}*
        fi
        mbsync -aV 
        if [ $? -ne 0 ]; then
            echo "mbsync failure" | systemd-cat -p err -t "mbsync"
        fi
        _mailsync
    else
        >&2 echo "mbsync already running ($pids)"
    fi
}

_imapjournal() {
    if [ -e $SYS_ONLINE ]; then
        _mbsync 2>&1 | systemd-cat -t "mailsync"
    fi
}

_search() {
    date +%s > $INDEX_FILE
    rm -f ${INDEXED}*
    notmuch search --output=files $@ | sed -e 's: :\\\\ :g' | xargs -r -I searchoutput ln -s searchoutput $INDEXED
}

_viewhtml() {
    local p has
    firefox $MUTTHTML
    while [ 1 -eq 1 ]; do
        has=0
        for p in $(pidof firefox); do
            cat /proc/$p/cmdline | grep -q "\.mutt\.html"
            if [ $? -eq 0 ]; then
                has=1
            fi
        done
        if [ $has -eq 0 ]; then
            break
        fi
        sleep 1
    done
    rm -f $MUTTHTML
}

if [ -z "$1" ]; then
    _imapjournal
else
    case "$1" in
        "client")
            if [ -z "$2" ]; then
                echo "account required"
                exit 1
            fi
            _imapjournal &
            sleep 0.5
            cd $HOME/Downloads
            mutt -F $HOME/.mutt/$2.muttrc
            touch $CHECK_MAIL
            ;;
        "search")
            _search ${@:2}
            ;;
        "count")
            _mailcount
            ;;
        "view")
            _viewhtml
            ;;
        *)
            echo "unknown command: $1"
            ;;
    esac
fi
