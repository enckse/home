#!/bin/bash
source $HOME/.bin/common
PRIMARY_ICON="cbatticon"
CUSTOM_STATS=$HOME/.cache/i3stats

# Get i3 workspaces (only name/number by default, more grep outputs available via first param)
function get-i3-workspaces()
{
    JSON_PATTERN="name"
    if [ ! -z "$1" ]; then
        JSON_PATTERN="$JSON_PATTERN|$1"
    fi
    WORKSPACE_INFO=$(i3-msg -t 'get_workspaces' | sed -e 's/{"num/\n{"num/g' | sed -e 's/,"/\n/g' | grep -E "$JSON_PATTERN" | cut -d\" -f 3)
    echo "$WORKSPACE_INFO"
}

function close-all-containers()
{
    PARENT="true"
    while [[ "$PARENT" == *"true"* ]];
    do
        PARENT=$(i3-msg focus parent);
    done
    i3-msg kill
}

function rename-workspace()
{
    get-i3-workspaces | grep -q $1
    if [ $? -ne 0 ]; then
        i3-msg rename workspace to $1
    fi
}

function _tray_count()
{
    ps ax | grep -v "grep" | grep $1 | wc -l
}

function _run_python()
{
    _run_if_not 0 "python.*$1" "$2"
}

function _run_if_not()
{
    val=$1
    cmd=$(echo "$2" | sed "s/python\.\*//g")
    if [ $(_tray_count $2) -lt $((val+1)) ]; then
        $cmd $3 &
    fi
    sleep 1.0
}

function _kill_tray()
{
    if [ $(_tray_count "$PRIMARY_ICON") -eq 0 ]; then
        pkill cbatticon
        pkill volumeicon
        for p in $(pidof python); do
            cat /proc/$p/cmdline | grep -q -E "udiskie|wsw-applet|icons"
            if [ $? -eq 0 ]; then
                kill $p
            fi
        done
    fi
}

function tray_reload()
{
    _force_kill
}

function _force_kill()
{
    pkill $PRIMARY_ICON
    _kill_tray
    if [ -z "$1" ]; then
        sleep 0.5
    else
        i3-msg $1
    fi
    tray_icons
}

function reload()
{
    _force_kill "reload"
}

function restart()
{
    _force_kill "restart"
}

function _tray_icons()
{
    _kill_tray
    for b in $(echo "0 1"); do
        _run_if_not $b "cbatticon" "-d BAT$b"
    done
    _run_if_not 0 "volumeicon"
    _run_python "wsw-applet" ""
    _run_python "udiskie" "--no-notify --no-automount --no-config --tray -f \"\""
    _run_python "icons" ""

}

function tray_icons()
{
    _tray_icons &
    touch $TRAY_SET
}

function stats()
{
    if [ -e $CUSTOM_STATS ]; then
        $CUSTOM_STATS
    else
        i3status | while :
        do
            read line
            echo "$line" || exit 1
        done
    fi
}

function onchanging()
{
    git-changes > $GIT_CHANGES
}

function usbchange()
{
    docked
    exit 0
}
$1 $2 
