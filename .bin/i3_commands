#!/bin/bash
source $HOME/.bin/common

auto-clip() {
    source $PRIV_CONF
    auto-clipboard $PERM_LOCATION
}

_update-workspace() {
    local name
    name="$1:"$(echo "${@:3}" | tr '[:upper:]' '[:lower:]' | tr ' ' '|' | sed "s/^|//g")
    i3-msg rename workspace "$2" to "$name" > /dev/null
}

_msgparse() {
    i3-msg -t $1 | tr '{' '\n' | tr '}' '\n' | tr ',' '\n' | sed 's/"//g'
}

_lastworkspace() {
    local res
    res=$(echo "${@:2}" | grep "^$1:")
    if [ -z "$res" ]; then
        echo "$1"
    else
        echo "$res"
    fi
}

_workspace() {
    local objs o lastnum current val workspaces lastworkspace
    lastnum=-1
    workspaces=$(_msgparse "get_workspaces" | grep -E "^name:" | cut -d ":" -f 2-)
    objs=$(_msgparse "get_tree" | grep -E "^(class|num):" | grep -v "num:\-" | cut -d " " -f 1 | grep -v "class:i3bar")
    for o in $(echo "$objs"); do
        val=$(echo $o | cut -d ":" -f 2)
        if echo "$o" | grep -q "^num:"; then
            if [ $lastnum -ne $val ]; then
                if [ $lastnum -ne -1 ]; then
                    lastworkspace=$(_lastworkspace "$lastnum" "$workspaces")
                    _update-workspace "$lastnum" "$lastworkspace" "$current"
                fi
                lastnum=$val
                current=""
            fi
        else
            current="$current $val"
        fi
    done
    lastworkspace=$(_lastworkspace "$lastnum" "$workspaces")
    _update-workspace "$lastnum" "$lastworkspace" "$current"
}

workspacer() {
    while [ 1 -eq 1 ]; do
        _workspace
        sleep 1
    done
}

$1
