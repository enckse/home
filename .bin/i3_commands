#!/bin/bash
source $HOME/.bin/common
PRIMARY_ICON="wsw-applet"
CUSTOM_STATS=$HOME/.cache/i3stats

# Get i3 workspaces (only name/number by default, more grep outputs available via first param)
function get-i3-workspaces()
{
    JSON_PATTERN="name"
    if [ ! -z "$1" ]; then
        JSON_PATTERN="$JSON_PATTERN|$1"
    fi
    WORKSPACE_INFO=$(i3-msg -t 'get_workspaces' | sed -e 's/{"num/\n{"num/g' | sed -e 's/,"/\n/g' | grep -E "$JSON_PATTERN" | cut -d\" -f 3)
    echo "$WORKSPACE_INFO"
}

function _run_python()
{
    val=0
    cmd=$(echo "python.*$1" | sed "s/python\.\*//g")
    if [ $(ps ax | grep -v "grep" | grep $1 | wc -l) -lt $((val+1)) ]; then
        $cmd $2 &
    fi
    sleep 1.0
}

function _kill_tray()
{
    pkill $PRIMARY_ICON
    for p in $(pidof python); do
        cat /proc/$p/cmdline | grep -q -E "udiskie|workspaces"
        if [ $? -eq 0 ]; then
            kill $p
        fi
    done
}

function tray_reload()
{
    _force_kill
}

function _force_kill()
{
    _kill_tray
    if [ -z "$1" ]; then
        sleep 0.5
    else
        i3-msg $1
    fi
    tray_icons
}

function reload()
{
    _force_kill "reload"
}

function restart()
{
    _force_kill "restart"
}

function _tray_icons()
{
    _kill_tray
    wsw-applet &
    sleep 1.0
    _run_python "udiskie" "--no-notify --no-automount --no-config --tray -f \"\""
    _run_python "workspaces" ""
}

function tray_icons()
{
    _tray_icons &
}

function stats()
{
    if [ -e $CUSTOM_STATS ]; then
        $CUSTOM_STATS
    else
        i3status | while :
        do
            read line
            d=""
            if [ -e $MAIN_STATS ]; then
                d=$(cat $MAIN_STATS)
            fi
            echo "$d$line|" || exit 1
        done
    fi
}

$1 $2 
