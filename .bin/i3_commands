#!/bin/bash
source $HOME/.bin/common
PRIMARY_ICON="wsw-applet"
CUSTOM_STATS=$HOME/.cache/i3stats

# Get i3 workspaces (only name/number by default, more grep outputs available via first param)
function get-i3-workspaces()
{
    JSON_PATTERN="name"
    if [ ! -z "$1" ]; then
        JSON_PATTERN="$JSON_PATTERN|$1"
    fi
    WORKSPACE_INFO=$(i3-msg -t 'get_workspaces' | sed -e 's/{"num/\n{"num/g' | sed -e 's/,"/\n/g' | grep -E "$JSON_PATTERN" | cut -d\" -f 3)
    echo "$WORKSPACE_INFO"
}

function _run_python()
{
    val=0
    cmd=$(echo "python.*$1" | sed "s/python\.\*//g")
    if [ $(ps ax | grep -v "grep" | grep $1 | wc -l) -lt $((val+1)) ]; then
        $cmd $2 &
    fi
    sleep 1.0
}

function _kill_tray()
{
    pkill $PRIMARY_ICON
    for p in $(pidof python); do
        cat /proc/$p/cmdline | grep -q -E "udiskie|workspaces"
        if [ $? -eq 0 ]; then
            kill $p
        fi
    done
}

function tray_reload()
{
    _force_kill
}

function _force_kill()
{
    _kill_tray
    if [ -z "$1" ]; then
        sleep 0.5
    else
        i3-msg $1
    fi
    tray_icons
}

function reload()
{
    _force_kill "reload"
}

function restart()
{
    _force_kill "restart"
}

function _tray_icons()
{
    _kill_tray
    wsw-applet &
    sleep 1.0
    _run_python "udiskie" "--no-notify --no-automount --no-config --tray -f \"\""
    _run_python "workspaces" ""
}

function tray_icons()
{
    _tray_icons &
}

function update-git()
{
    if [ ! -e $GIT_CHANGES ]; then
        git-changing > $GIT_CHANGES
    fi
}

function _brightness()
{
    b=$(xrandr --current --verbose | grep "Brightness" | \
        cut -d ":" -f 2 | sed "s/0\.//g" | sed "s/1\.0/100/g" | \
        tail -n 1 | awk '{printf "%3.0f", $1}' | sed "s/^[ \t]*//g")
    printf '\xf0\x9f\x94\x86 %3i' $b    
}

function _battery()
{
    charging=$(cat /sys/class/power_supply/AC/online)
    charge="-"
    if [ $charging -eq 1 ]; then
        charge="+"
    fi
    lowest=100
    for b in $(echo '0 1'); do
        _path='/sys/class/power_supply/BAT'$b'/capacity'
        if [ -e $_path ]; then
            _bat=$(cat $_path)
            if [ $_bat -lt $lowest ]; then
                lowest=$_bat
            fi
        fi
    done
    printf '\xf0\x9f\x94\x8b %2i%s' $lowest $charge
}

function _sound()
{
    icon="\xf0\x9f\x94\x8a"
    if [[ $(pamixer --get-mute) == 'true' ]]; then
        icon='\xf0\x9f\x94\x87'
    fi
    level=$(pamixer --get-volume)
    printf "$icon %3i" $level
}

function _locking()
{
    if [ -e $DISPLAY_UN ]; then
        echo "unlocked"
    else
        if [ -e $DISPLAY_EN ]; then
            echo "no sleep"
        else
            echo " normal "
        fi
    fi
}

function stats()
{
    if [ -e $CUSTOM_STATS ]; then
        $CUSTOM_STATS
    else
        _last_git=0
        _git_text=""
        _last_cnt=0
        i3status | while :
        do
            read line
            if [ $_last_git -eq 0 ]; then
                _git_cnt=0
                if [ -e $GIT_CHANGES ]; then
                    _git_cnt=$(cat $GIT_CHANGES | grep "    " | wc -l)
                else
                    _git_cnt=$_last_cnt
                fi
                _last_cnt=$_git_cnt
                _git_text=" git notices|"
                if [ $_git_cnt -eq 0 ]; then
                    _git_text="no$_git_text"
                else
                    _git_text="$_git_cnt$_git_text"
                fi
                update-git &
            fi
            bright=$(_brightness)
            muting=$(_sound)
            bat=$(_battery)
            disp=$(_locking)
            echo "$_git_text$bright|$muting|$bat|$disp|$line|" || exit 1
            _last_git=$((_last_git+1))
            if [ $_last_git -eq 1 ]; then
                _last_git=0
            fi
        done
    fi
}

$1 $2 
