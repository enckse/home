#!/bin/bash
source $HOME/.bin/common
PRIMARY_ICON="wsw-applet"
CUSTOM_STATS=$HOME/.cache/i3stats

# Get i3 workspaces (only name/number by default, more grep outputs available via first param)
function get-i3-workspaces()
{
    JSON_PATTERN="name"
    if [ ! -z "$1" ]; then
        JSON_PATTERN="$JSON_PATTERN|$1"
    fi
    WORKSPACE_INFO=$(i3-msg -t 'get_workspaces' | sed -e 's/{"num/\n{"num/g' | sed -e 's/,"/\n/g' | grep -E "$JSON_PATTERN" | cut -d\" -f 3)
    echo "$WORKSPACE_INFO"
}

function _tray_count()
{
    ps ax | grep -v "grep" | grep $1 | wc -l
}

function _run_python()
{
    _run_if_not 0 "python.*$1" "$2"
}

function _run_if_not()
{
    val=$1
    cmd=$(echo "$2" | sed "s/python\.\*//g")
    if [ $(_tray_count $2) -lt $((val+1)) ]; then
        $cmd $3 &
    fi
    sleep 1.0
}

function _kill_tray()
{
    pkill wsw-applet
    if [ $(_tray_count "$PRIMARY_ICON") -eq 0 ]; then
        for p in $(pidof python); do
            cat /proc/$p/cmdline | grep -q -E "udiskie|icons"
            if [ $? -eq 0 ]; then
                kill $p
            fi
        done
    fi
}

function tray_reload()
{
    _force_kill
}

function _force_kill()
{
    pkill $PRIMARY_ICON
    _kill_tray
    if [ -z "$1" ]; then
        sleep 0.5
    else
        i3-msg $1
    fi
    tray_icons
}

function reload()
{
    _force_kill "reload"
}

function restart()
{
    _force_kill "restart"
}

function _tray_icons()
{
    _kill_tray
    wsw-applet &
    sleep 1.0
    _run_python "udiskie" "--no-notify --no-automount --no-config --tray -f \"\""
    _run_python "icons" ""

}

function tray_icons()
{
    _tray_icons &
    touch $TRAY_SET
}

function update-git()
{
    if [ ! -e $GIT_CHANGES ]; then
        git-changing > $GIT_CHANGES
    fi
}

function stats()
{
    if [ -e $CUSTOM_STATS ]; then
        $CUSTOM_STATS
    else
        _last_git=0
        _git_text=""
        _last_cnt=0
        i3status | while :
        do
            read line
            if [ $_last_git -eq 0 ]; then
                _git_cnt=0
                if [ -e $GIT_CHANGES ]; then
                    _git_cnt=$(cat $GIT_CHANGES | grep "    " | wc -l)
                else
                    _git_cnt=$_last_cnt
                fi
                _last_cnt=$_git_cnt
                _git_text=" git notices|"
                if [ $_git_cnt -eq 0 ]; then
                    _git_text="no$_git_text"
                else
                    _git_text="$_git_cnt$_git_text"
                fi
                update-git &
            fi
            echo "$_git_text$line" || exit 1
            _last_git=$((_last_git+1))
            if [ $_last_git -eq 1 ]; then
                _last_git=0
            fi
        done
    fi
}

$1 $2 
