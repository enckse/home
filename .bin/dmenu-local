#!/bin/bash
source $HOME/.bin/common
CACHE_DIR=${HOME_CACHE}dmenuurls/
URLS=$PERM_CONFIGS/urls.csv
BROWSER="/usr/bin/firefox"
HASHED=$USER_TMP/.dmenu_urls
LOCAL_APPS="gmutt fastmutt passwords irc"
APPS="vlc pavucontrol $LOCAL_APPS"
AVAILABLE="$USER_TMP/.dmenu_available"

_dmenucall() {
    echo "$@" | ${SHELL:-"/bin/sh"}
    exit 0
}

_termite() {
    echo "termite --title=$1 --exec='$2'"
}

_localapp() {
    local cmd
    case "$1" in
        "gmutt")
            cmd=$(_termite $1 "${HOME_BIN}email client gmail")
            ;;
        "fastmutt")
            cmd=$(_termite $1 "${HOME_BIN}email client fastmail")
            ;;
        "irc")
            cmd=$(_termite $1 "weechat")
            ;;
        "passwords")
            cmd="keepassx2 ${SYNCED_PATH}passwords"
            ;;
    esac
    _dmenucall "$cmd"
}

_matches() {
    echo "$1" | tr ' ' '\n' | grep -q "^$results$"
    echo $?
}

_dmenuwrapper() {
    local results urls u name url params file hashed prev names blist
    hashed=$(sha256sum $URLS | cut -d " " -f 1)
    prev=""
    if [ -e "$AVAILABLE" ]; then
        if [ $(ls $CACHE_DIR | wc -l) -gt 0 ]; then
            if [ -e $HASHED ]; then
                prev=$(cat $HASHED)
            fi
        fi
    fi
    echo "$hashed" > $HASHED
    if [[ "$hashed" != "$prev" ]]; then
        urls=""
        names="$APPS"
        rm -f $CACHE_DIR*
        for u in $(cat $URLS | sed 's/"//g'); do
            name=$(echo "$u" | cut -d "," -f 1)
            file="$CACHE_DIR$name"
            url=$(echo "$u" | cut -d "," -f 2)
            params=$(echo "$u" | cut -d "," -f 3)
            names="$names $name"
            echo "$BROWSER $params $url" > $file
        done
        names=$(echo $names)
        echo "$names" | tr ' ' '\n' | sort -u > $AVAILABLE
    fi
    results=$(cat $AVAILABLE | dmenu "$@")
    file="$CACHE_DIR/$results"
    if [ -e "$file" ]; then
        _dmenucall $(cat $file)
    fi
    if [ $(_matches "$LOCAL_APPS" "$results") -eq 0 ]; then
        _localapp "$results"
    fi
    if [ $(_matches "$APPS" "$results") -eq 0 ]; then
        _dmenucall "$results"
    fi
    echo "$results"| grep "\." | grep -q -v " "
    if [ $? -eq 0 ]; then
        _dmenucall "$BROWSER $results"
    fi
    results=$(echo "$results" | sed "s/^search //g")
    results=$(echo $results)
    results="$(perl -MURI::Escape -e 'print uri_escape($ARGV[0]);' "$results")"
    _dmenucall "$BROWSER https://www.duckduckgo.com/?q=$results"
}

_dmenuwrapper "$@"
