#!/bin/bash
source $HOME/.bin/common
DISPLAY_KEY="backlight"
WORKSPACES_KEY="workspaces"
HELP="help"
BACKLIGHT_ON="up"
BACKLIGHT_OFF="down"
FULL_BRIGHT="full"
LOW_BRIGHT="low"
MID_BRIGHT="mid"
MAIN_DISPLAY="eDP1"
DISP_ONE="DP2-2"
DISP_TWO="DP2-1"
DEFAULT_WORKSPACE_ID=1
DOCKED_ID=2
HOME_WORKPLACE_ID=3
WORK_LEFT="--output $DISP_ONE --auto --left-of $MAIN_DISPLAY --rotate right"
WORK_RIGHT="--output $DISP_TWO --auto --right-of $MAIN_DISPLAY"
HOME_RIGHT="--output $DISP_ONE --auto --right-of $MAIN_DISPLAY --rotate right"
HOME_LEFT="--output $DISP_TWO --auto --left-of $MAIN_DISPLAY"
TRACK_LIGHTING=$USER_TMP/.backlight

function force-display-on()
{
    xset -display $MAIN_DISPLAY dpms force on
}

# Get displays, first argument can filter out any displays
function get-displays()
{
    get-all-displays " "
}

function get-all-displays()
{
    xrandr | grep "${1}connected" | cut -d " " -f 1
}

# Toggle backlighting up/down to a specified level
function toggle-backlighting()
{
    local _action _current _displays setting
    if [ ! -e $TRACK_LIGHTING ]; then
        echo "$MID_BRIGHT" > $TRACK_LIGHTING
    fi

    _action=$1
    _current=$(cat $TRACK_LIGHTING)
    case $1 in
        $BACKLIGHT_ON)
            if [[ "$_current" == "$LOW_BRIGHT" ]]; then
                _action=$MID_BRIGHT
            else
                _action=$FULL_BRIGHT
            fi
            ;;
        $BACKLIGHT_OFF)
            if [[ "$_current" == "$FULL_BRIGHT" ]]; then
                _action=$MID_BRIGHT
            else
                _action=$LOW_BRIGHT
            fi
            ;;
    esac
    if [[ "$_action" != "$1" ]]; then
        echo "$_action" > $TRACK_LIGHTING
    fi

    case $_action in
        $FULL_BRIGHT)
            setting=1.0
            ;;
        $LOW_BRIGHT)
            setting=0.3
            ;;
        $MID_BRIGHT)
            setting=0.9
            ;;
        *)
            echo "Unknown command $1"
            ;;
    esac
    
    if [ ! -z "$setting" ]; then
        _displays=$(get-displays)
        for disp in ${_displays[@]}; do
            xrandr --output $disp --brightness $setting
        done
    fi
}

function set-workplace()
{
    ALL_DISPLAYS=$(get-all-displays | grep -v "$MAIN_DISPLAY")
    has_side=0
    for disp in $ALL_DISPLAYS; do
        xrandr --output $disp --off
        xrandr | grep -q "^$disp connected"
        if [ $? -eq 0 ]; then
            has_side=1
        fi
    done
    xrandr --output $MAIN_DISPLAY --primary --auto
    use_setting=$1
    if [ $has_side -eq 0 ]; then
        use_setting=$DEFAULT_WORKSPACE_ID
    fi
    case $use_setting in
        $DOCKED_ID)
            xrandr $WORK_LEFT
            xrandr $WORK_RIGHT
            ;;
        $HOME_WORKPLACE_ID)
            xrandr $HOME_RIGHT
            xrandr $HOME_LEFT
            ;;
    esac
    toggle-backlighting $MID_BRIGHT
    if [ $1 -eq $use_setting ]; then
        i3 restart
    fi
}

function force-workplace()
{
    set-workplace $1
    xsetroot -solid "#333333"
}

function get-help()
{
    echo
    echo "$BACKLIGHT_ON (toggle backlights ON)
$BACKLIGHT_OFF (toggle backlights OFF)
$LOW_BRIGHT (low brightness)
$MID_BRIGHT (medium brightness)
$FULL_BRIGHT (full brightness)" | sed "s/^/$DISPLAY_KEY /g"
    echo
    echo "$DEFAULT_WORKSPACE_ID (force default workspace)
$DOCKED_ID (force docked workspace)
$HOME_WORKPLACE_ID (change to home workspace)" | sed "s/^/$WORKSPACES_KEY /g"
    echo
}

# Workspace commands
function workspace-subsystem()
{
    local has_main cmd
    has_main=$(get-all-displays | grep "^$MAIN_DISPLAY$")
    if [ -z "$has_main" ]; then
        echo "MISSING MAIN DISPLAY: $MAIN_DISPLAY"
        cmd=""
    fi
    force-workplace "$1"
}

if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    echo > /dev/null
else
    if [ -z "$1" -o -z "$2" ]; then
        get-help | sed "s/^/    /g" | sed "s/^    $//g"
        exit 1
    fi
    case $1 in
        $DISPLAY_KEY)
            CMD=toggle-backlighting
            ;;
        $WORKSPACES_KEY)
            CMD=workspace-subsystem
            ;;
    esac
    if [ -z $CMD ]; then
        echo "unknown action: $1"
    else
        $CMD "$2"
    fi
fi
