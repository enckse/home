#!/bin/bash
source $HOME/.bin/displays
source $HOME/.bin/common
DISPLAY_KEY="display"
DISPLAY_TOGGLE="toggle"
DISPLAY_CHANGE="change"
WORKSPACES_KEY="workspaces"
FORCE_WORKSPACE="force"
PROF_KEY="profiles"
ALL_AVAILBLE="$DISPLAY_KEY $WORKSPACES_KEY $SYS_STATS_KEY"
HELP="help"

function get-help()
{
    echo "commands"
    echo "--------"
    echo
    for item in $ALL_AVAILBLE; do
        case $item in
            $DISPLAY_KEY)
                get-lighting-help $item $DISPLAY_TOGGLE $DISPLAY_CHANGE $PROF_KEY
                ;;
            $WORKSPACES_KEY)
                get-workspace-help $item $FORCE_WORKSPACE
                ;;
        esac
    done
}

# Workspace commands
function workspace-subsystem()
{
    case $1 in
        $FORCE_WORKSPACE)
            force-workplace "$2"
            ;;
        *)
            echo "Unknown workspaces request: $1"
            exit -1
            ;;
    esac
}

# Display commands
function display-subsystem()
{
    case $1 in
        $DISPLAY_TOGGLE | $DISPLAY_CHANGE)
            toggle-backlighting "$2"
            ;;
        $PROF_KEY)
            cycle-profiles "$2"
            ;;
        *)
            echo "Unknown display command $1"
            exit -1
    esac
}

function cycle-profiles()
{
    if [[ "$1" == "$PROFILE_CYCLE" ]]; then
        full_backlight="full"
        mid_backlight="mid"
        low_backlight="low"
        use_profile=$full_backlight
        if [ -e $PROFILE_DEF ]; then
            use_profile=$(cat $PROFILE_DEF)
        fi
        
        next_back=""
        case $use_profile in
            $full_backlight)
                subsystem display change full
                next_back=$mid_backlight
                ;;
            $low_backlight)
                toggle-backlighting $LOW_BRIGHT
                ;;
            $mid_backlight)
                toggle-backlighting $MID_BRIGHT
                next_back=$low_backlight
                ;;
        esac

        rm -f $PROFILE_DEF
        if [ ! -z $next_back ]; then
            echo $next_back > $PROFILE_DEF
        fi
    else 
        echo "Unknown profile action $1 $2"
    fi
}

if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    echo > /dev/null
else
    if [ -z "$1" -o -z "$2" -o -z "$3" ]; then
        HEADER="subsystem, command, and value required ($1 and $2 and $3 ?)"
        if [ ! -z "$1" ]; then
            if [[ "$1" == "$HELP" ]]; then
                HEADER=""
            fi
        fi
        
        if [ ! -z "$HEADER" ]; then
            echo $HEADER
            echo
        fi
        
        get-help
        exit -1
    fi
    case $1 in
        $DISPLAY_KEY)
            CMD=display-subsystem
            ;;
        $WORKSPACES_KEY)
            CMD=workspace-subsystem
            ;;
        *)
            echo "Unknown action $1"
            ;;
esac

    if [ ! -z $CMD ]; then
        $CMD "$2" "$3"
    fi
fi
