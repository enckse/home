#!/usr/bin/python3
"""Debian package uploading."""
import os
import tempfile
import debian
import common
import shutil
import subprocess
import urllib.request


_REPOS = {"stable": "stretch", "unstable": "sid"}
_DISTS = "dists"


def _upload(env):
    """Upload the package."""
    target = "{}:/opt/debian".format(env.MIRROR_SERVER)
    subprocess.call(["rsync", "-avc", "-e", "ssh", _DISTS, target])


def _pack(env, pool, objects):
    """Package pools."""
    print("packaging...")
    repos = sorted(set([x.repo for x in objects]))
    for r in repos:
        if r not in _REPOS:
            raise Exception("unknown repo")
        codename = _REPOS[r]
        dist = os.path.join("dists", r)
        for comp in env.MIRROR_COMPONENTS.split(" "):
            root = os.path.join(dist, comp, "binary-amd64")
            os.makedirs(root)
            flt = ["all", comp]
            debs = [x.deb for x in objects if x.repo == r and x.filter in flt]
            for d in debs:
                shutil.copyfile(os.path.join(pool, d),
                                os.path.join(root, d))
            packages = os.path.join(root, "Packages")
            with open(packages, 'w') as f:
                subprocess.call(["apt-ftparchive", "packages", root], stdout=f)
            old_packages = os.path.join(pool, "{}.{}.packages".format(r, comp))
            if os.path.exists(old_packages):
                res = subprocess.call(["diff", "-u", old_packages, packages])
                if res != 0:
                    print("please review changes to {}:{}".format(r, comp))
                    input()
                    shutil.copyfile(packages, old_packages)
            package_gz = packages + ".gz"
            with open(package_gz, 'w') as f:
                subprocess.call(["gzip",
                                 "-c",
                                 "--keep",
                                 "--force",
                                 "-9",
                                 packages],
                                stdout=f)
        with open(os.path.join(dist, "Date"), 'w') as f:
            subprocess.call(["date", "+%Y-%m-%d-%H-%M-%S"], stdout=f)
        release_file = os.path.join(dist, "Release")
        with open(release_file, 'w') as f:
            obj = {"Suite": r,
                   "Codename": codename,
                   "Components": env.MIRROR_COMPONENTS}
            for o in obj:
                f.write("{}: {}\n".format(o, obj[o]))
        with open(release_file, 'a') as f:
            subprocess.call(["apt-ftparchive", "release", dist], stdout=f)
        subprocess.call(["gpg",
                         "--clearsign",
                         "--digest-algo",
                         "SHA512",
                         "--local-user",
                         env.DEB_SIGN_KEY,
                         "-o",
                         os.path.join(dist, "InRelease"),
                         release_file])
        subprocess.call(["gpg",
                         "--yes",
                         "-abs",
                         "--local-user",
                         env.DEB_SIGN_KEY,
                         "-o",
                         release_file + ".gpg",
                         release_file])
    return True


def main():
    """Program entry."""
    deb_env = common.read_env()
    if not os.path.exists(deb_env.REPOSITORY):
        print("invalid input path")
        return
    mani = os.path.join(deb_env.REPOSITORY, debian.MANIFEST)
    m = debian.parse_manifest(mani)
    tmpd = "/home/enck/downloads/test/"
    tmpd = tempfile.mkdtemp()
    try:
        os.chdir(tmpd)
        if _pack(deb_env, deb_env.REPOSITORY, m):
            print("push to {} (Y/n)?".format(deb_env.MIRROR_SERVER))
            y = input()
            if y != "n":
                _upload(deb_env)
        shutil.rmtree(tmpd)
    except Exception as e:
        shutil.rmtree(tmpd)
        raise


if __name__ == "__main__":
    main()
