#!/usr/bin/perl
use strict;
use warnings;
use autodie;
use Sys::Hostname;

my $host   = hostname;
my $dir    = $ENV{"HOME"} . "/store/personal/mirror/notebook/";
my $dirbin = $dir . "bin";
my $md     = (@ARGV) ? shift @ARGV : "";
die "not a markdown file: $md" if ( not $md =~ m/\.md$/ );
my $page = $dir . "$md";
system("vim $page");

my $yaml = `cd $dir && echo 'target: bin
home: README.md
site: notes

pages:
    directory: pages
    side:'
    for f in \$(ls pages/ | sed 's/\\.md//g' | sort); do
        echo \"      \$f: \$f\"
    done
    echo '
    top:
        references: references'`;
chomp $yaml;
system("echo '$yaml' > $dir/site.yaml");
system("cd $dir && labsite local > /dev/null");

my $wiki = $ENV{"HOME"} . "/.cache/wiki/";
system("rsync -av $dirbin/ $wiki --delete-after > /dev/null");
system("rm -rf $dirbin");
system("ln -s $wiki $dirbin");
if ( system('wsw status') == 0 ) {
    print "uploading\n";
    system( "rsync -avcr --delete-after $dir/ "
          . $ENV{"SERVER"}
          . ":~/store/Active/Drop/Mirror/$host.notebook | sed 's/^/ ->    /g'"
    );
}
