#!/bin/bash
if pgrep -x mbsync > /dev/null; then
    exit 0
fi

_sync() {
    mbsync -a
    notmuch new
}

if [ -z "$1" ]; then
    mkdir -p /tmp/mbsync
    _sync 2>&1 | systemd-cat -t "mbsync"
else
    case "$1" in
        "status")
            oldifs=$IFS
            IFS=$'\n'
            for d in $(find ~/store/personal/imap -type d -name new | grep -v Trash); do
                dname=$(dirname $d)
                count=$(ls $dname/new/ | wc -l)
                if [ $count -gt 0 ]; then
                    notify-send -t 30000 "$(echo $dname | sed 's#/home/enck/store/personal/imap/##g' | cut -d "/" -f 2-) [$count]"
                fi
            done
            IFS=$oldifs
            ;;
    esac
fi
