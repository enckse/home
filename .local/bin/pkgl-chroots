#!/bin/bash
COMMAND="$@"
_header() {
    echo
    echo "=== $1 ==="
    echo
}

if [ -z "$COMMAND" ]; then
    _header "builds"
    sudo rsync -avc $HOME/store/managed/pacman/ $CHROOT/root/opt/pacman/ --delete-after
    arch-nspawn $CHROOT/root pacman -Syyu
    COMMAND="pacman -Syyu"
fi
for f in $(ls $CHROOT/.. | grep -v builds); do
    _header $f
    sudo schroot -c source:$f -- $COMMAND
done
