#!/bin/bash
COMMAND="$@"
_header() {
    echo
    echo "=== $1 ==="
    echo
}

if [ -z "$COMMAND" ]; then
    _header "builds"
    sudo rsync -avc $HOME/store/managed/pacman/ $CHROOT/root/opt/pacman/ --delete-after
    arch-nspawn $CHROOT/root pacman -Syyu
    COMMAND="pacman -Syyu"
    sudo schroot -c source:debian -- apt update
    sudo schroot -c source:debian -- apt upgrade
fi
for f in $(ls $CHROOT/.. | grep -v builds | grep -v debian); do
    _header $f
    sudo schroot -c source:$f -- $COMMAND
done
