#!/usr/bin/perl
use strict;
use warnings;

sub muted {
    return system("pactl list sinks | grep -q 'Mute: yes'") == 0;
}

sub current {
    return 0 if muted;
    my $volume =
`pactl list sinks | grep -E "Volume" | grep -v "Base Volume:" | cut -d "/" -f 2 | cut -d "%" -f 1 | sed "s/^\\s*//g" | awk '{ sum += \$2 } END { print \$sum }'`;
    chomp $volume;
    return $volume;
}

sub pactl {
    my $cmd = shift @_;
    my $val = shift @_;
    for ( ( 0, 1, 2, 3, 4 ) ) {
        system("pactl $cmd $_ $val > /dev/null 2>&1");
    }
}

my $cmd = "status";
if (@ARGV) {
    $cmd = shift @ARGV;
}

if ( $cmd eq "status" ) {
    print current;
    exit 0;
}
elsif ( $cmd eq "mute" or $cmd eq "togglemute" ) {
    my $mute = "1";
    if ( $cmd eq "togglemute" ) {
        $mute = "0" if muted;
    }
    pactl "set-sink-mute", $mute;
    exit 0;
}
elsif ( $cmd eq "inc" or $cmd eq "dec" ) {
    my $current = 0 + current;
    my $delta   = "";
    if ( $cmd eq "inc" ) {
        if ( $current < 100 ) {
            $delta = "+";
        }
    }
    else {
        if ( $current > 0 ) {
            $delta = "-";
        }
    }
    if ($delta) {
        pactl "set-sink-volume", "${delta}10%";
    }
}
