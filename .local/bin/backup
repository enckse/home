#!/bin/bash
DRYRUN=0
CLEAR=0
if [ ! -z "$1" ]; then
    case "$1" in
        "status")
            DRYRUN=1
            ;;
        "clear")
            CLEAR=1
            ;;
        *)
            echo "unknown command $1"
            exit 1
            ;;
    esac
fi

if [ $DRYRUN -eq 0 ]; then
    ssh -o BatchMode=yes -o ConnectTimeout=5 core echo is-online > /dev/null
    if [ $? -ne 0 ]; then
        echo "backup system not online"
        exit 1
    fi
fi

MIRRORS="$HOME/store/personal/mirror/"
REPOS="$HOME/store/personal/private/"
CACHE=$HOME/.cache/backup/
FILES=${CACHE}files.txt
LAST=$FILES.backup
CHECK=${CACHE}$(date +%Y-%m-%d.%H).txt
NOTIFY=${CACHE}notify
touch $FILES $LAST

_clear() {
    rm -f $NOTIFY
}

if [ $CLEAR -eq 1 ]; then
    _clear
    exit 0
fi

_hash() {
    local dir
    for dir in $MIRRORS $REPOS; do
        find $dir -type f -printf "%p.%TY-%Tm-%TdT%TH:%TM:%TS\n"
    done
}

_dryrun() {
    if [ -e $CHECK ]; then
        return
    fi
    _hash | sort > $FILES
    diff -u $FILES $LAST | systemd-cat -t "backup"
    if [ $? -ne 0 ]; then
        touch $NOTIFY
    fi
    mv $FILES $LAST
}

if [ $DRYRUN -ne 0 ]; then
    _dryrun
    if [ -e $NOTIFY ]; then
        notify-send -t 30000 "backup"
    fi
    touch $CHECK
    exit 0
fi


mkdir -p $CACHE
echo "cleaning up cache"
find $CACHE -type f -mtime +30 -exec rm {} \;
find $CACHE -type f -name "$(date +%Y)*" -mtime +3 -exec rm {} \;

echo
echo "backing up mirrors"
for f in $(find $MIRRORS -maxdepth 1 -mindepth 1 -type d); do
    echo " -> $f"
    rsync -avcr --exclude Trash --delete-after $f/ core:~/store/Active/Drop/Mirror/$(basename $f) | sed "s/^/    /g"
done

echo
echo "backing up git repos"
for f in $REPOS; do
    echo " -> $f"
    commit=$(git -C $f log --format=%h -n 1)
    zippass=$(PASSWORD_STORE_DIR=~/.pass/personal pass show keys/zips)
    zipfile=${CACHE}$(basename $f).$commit.7z
    if [ -e $zipfile ]; then
        continue
    fi
    rm -f $zipfile
    7z a -spf -p$zippass $zipfile $(find $f -type f | grep -v "\.git")
    perl ~/.local/lib/inbox.pl \
            --input $zipfile \
            --subject "$(basename $f).zip"
done

rm -f $NOTIFY
rm -f $CHECK
_dryrun
profiles=${CACHE}profiles.$(date +%s).tar.gz
pacman -Qqe > ~/.cache/packages
tar czf $profiles ~/.mozilla ~/.bash_history ~/.cache/packages 2> /dev/null
echo
echo "sending profiles"
scp $profiles core:~/store/Active/Drop/Profiles
rm -f $profiles
echo
echo "cleaning up profiles"
for f in $(ssh core find ~/store/Active/Drop/Profiles -mtime +7); do
    ssh core rm $f
done
echo
echo "sending etc archive"
for f in $(find $CACHE -type f -name "*.backup.tar.gz"); do
    scp $f core:~/store/Active/Drop/Profiles/
    rm $f
done
_clear
