#!/bin/bash

NO_STATUS=/tmp/nostatus

if [ ! -z "$1" ]; then
    case "$1" in
        "displays")
            displays=$HOME/.cache/displays
            prev=$displays.prev
            xrandr | grep " connected" | cut -d " " -f 1 > $displays
            touch $prev
            diff -u $displays $prev > /dev/null
            exited=$?
            mv $displays $prev
            if [ $exited -ne 0 ]; then
                count=$(cat $prev | wc -l)
                if [ $count -gt 1 ]; then
                   workspaces docked
                else
                   workspaces
                fi
            fi
            ;;
        "toggle")
            change="on"
            if [ -e "$NO_STATUS" ]; then
                rm -f $NO_STATUS
            else
                change="off"
                touch $NO_STATUS
            fi
            notify-send -t 5000 "notifications: $change"
            ;;
        "notify")
            if [ ! -e "$NO_STATUS" ]; then
                gitstatus
                mail status
                backup status
                pacstatus
            fi
            ;;
        "sleep")
            rm -f $NO_STATUS
            ;;
        "mail")
            ltcten online
            if [ $? -ne 0 ]; then
                exit 0
            fi
            ltcten status | grep -q -E "home|default"
            if [ $? -ne 0 ]; then
                exit 0
            fi
            mkdir -p /tmp/mail/
            timestamp=/tmp/mail/$(date -d @$(( (($(date +%s) + 900) / 1800) * 1800)) +%Y-%m-%d-%H-%M).txt
            if pgrep -x mutt; then
                rm -f $timestamp
                exit 0
            fi
            if [ -e $timestamp ]; then
                exit 0
            fi
            mail
            touch $timestamp
            ;;
    esac
    exit 0
fi

_status() {
    date=$(date +%Y-%m-%d)
    week=$(date +%a | tr '[:lower:]' '[:upper:]')
    time=$(date +%H:%M)
    bright=$(brightness status)
    locked=$(locker status)
    if [ ! -z "$locked" ]; then
        locked="|$locked"
    fi
    vol=$(volume status)
    bat=$(cat /sys/class/power_supply/BAT0/capacity)
    charge="-"
    if [ $(cat /sys/class/power_supply/AC/online) -eq 1 ]; then
        charge="+"
    else
        if [ $bat -lt 20 ]; then
            notify-send -t 30000 "BATTERY LOW"
        fi
    fi
    online="UP"
    ltcten online
    if [ $? -ne 0 ]; then
        online="DOWN"
    fi
    addr=$(ltcten addr)
    echo "$date|$week|$time$locked|disp:$bright|vol:$vol|bat:$bat$charge|$online:$addr"
}

count=1
while [ 1 -eq 1 ]; do
    xsetroot -name $(_status)
    count=$((count+1))
    if [ $count -eq 5 ]; then
        status notify &
        status mail &
        count=0
    fi
    status displays &
    sleep 5
done
