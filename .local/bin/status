#!/bin/bash

NO_STATUS=/tmp/nostatus

if [ ! -z "$1" ]; then
    case "$1" in
        "toggle")
            perl ~/.local/bin/status.pl toggle
            ;;
    esac
    exit 0
fi

_status() {
    date=$(date +%Y-%m-%d)
    week=$(date +%a | tr '[:lower:]' '[:upper:]')
    time=$(date +%H:%M)
    bright=$(brightness status)
    locked=$(locker status)
    if [ ! -z "$locked" ]; then
        locked="|$locked"
    fi
    vol=$(volume status)
    bat=$(cat /sys/class/power_supply/BAT0/capacity)
    charge="-"
    if [ $(cat /sys/class/power_supply/AC/online) -eq 1 ]; then
        charge="+"
    else
        if [ $bat -lt 20 ]; then
            notify-send -t 30000 "BATTERY LOW"
        fi
    fi
    online="UP"
    ltcten online
    if [ $? -ne 0 ]; then
        online="DOWN"
    fi
    addr=$(ltcten addr)
    echo "$date|$week|$time$locked|disp:$bright|vol:$vol|bat:$bat$charge|$online:$addr"
}

count=1
while [ 1 -eq 1 ]; do
    xsetroot -name $(_status)
    count=$((count+1))
    if [ $count -eq 5 ]; then
        perl ~/.local/bin/status.pl notify &
        perl ~/.local/bin/status.pl mail &
        count=0
    fi
    perl ~/.local/bin/status.pl displays &
    sleep 5
done
