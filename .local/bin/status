#!/usr/bin/perl
use warnings;
use strict;
use File::Compare;
use File::Copy qw(move);
use autodie;

my $bat_path       = "/sys/class/power_supply/BAT";
my $no_status      = "/tmp/nostatus";
my $home           = $ENV{"HOME"};
my $battery_notice = $ENV{"NOTIFY_MESSAGES"} . "/battery";
my $history_root   = "$home/.cache/history/";

sub create_status() {
    my $date     = `date +%Y-%m-%d`;
    my $week     = `date +%a | tr '[:lower:]' '[:upper:]'`;
    my $time     = `date +%H:%M`;
    my $bright   = `sys brightness`;
    my $vol      = `sys volume-status`;
    my $bat_text = "";
    if ( -e "/usr/bin/acpi" ) {
        my $bat_stat = "";
        my $bat      = 0;
        for ( ( 0, 1 ) ) {
            my $bat_cur = `acpi | grep "Battery $_:" | cut -d "," -f 2`;
            chomp $bat_cur;
            if ($bat_cur) {
                $bat_cur =~ s/ //g;
                $bat_cur =~ s/%//g;
                if ($bat_stat) {
                    $bat_stat = "$bat_stat,";
                }
                $bat_stat = "$bat_stat$bat_cur";
                $bat      = $bat + $bat_cur;
            }
        }
        my $warning = 0;
        my $charge  = `status charging`;
        if ( $charge ne "+" ) {
            if ( $bat < 20 ) {
                $warning = 1;
                system("echo 'battery:LOW' > $battery_notice");
            }
        }
        system("rm -f $battery_notice") if $warning == 0;
        $bat_text = "|bat:$bat_stat$charge";
    }
    my $online = system("wsw online") ? "DOWN" : "UP";
    my $addr   = `wsw addr`;
    my $status =
      "$date|$week|$time|disp:$bright|vol:$vol$bat_text|$online:$addr";
    $status =~ s/\n//g;
    system("xsetroot -name '$status'");
}

if (@ARGV) {
    my $command = $ARGV[0];
    if ( $command eq "charging" ) {
        my $charge = "-";
        if ( `cat /sys/class/power_supply/AC/online` == "1" ) {
            $charge = "+";
        }
        print $charge;
    }
    elsif ( $command eq "toggle" || $command eq "sleep" ) {
        my $change = "on";
        if ( -e "$no_status" || $command eq "sleep" ) {
            system("rm -f $no_status");
        }
        else {
            $change = "off";
            system("touch $no_status");
        }
        if ( $command ne "sleep" ) {
            system("notify-send -t 5000 'notifications: $change'");
        }
    }
    elsif ( $command eq "mail" ) {
        exit if system("wsw online");
        exit if system("wsw status") != 0;
        my $mail_files = "/tmp/mail";
        if ( !-d $mail_files ) {
            mkdir $mail_files;
        }
        my $time = `date +%Y-%m-%d-%H-`;
        chomp $time;
        $time .= `date +%M` >= 30 ? "30" : "00";
        $mail_files = $mail_files . "/$time";

        unless ( system("pgrep -x mutt > /dev/null") ) {
            system("rm -f $mail_files");
            exit;
        }
        exit if -e "$mail_files";
        system("sys mail");
        system("touch $mail_files");
    }
    elsif ( $command eq "notify" ) {
        if ( not -e $no_status ) {
            system("perl $home/.local/lib/notify.pl");
        }
    }
    elsif ( $command eq "line" ) {
        create_status;
    }
    elsif ( $command eq "cleanup" ) {
        my $cleanup_date = `date +%Y-%m-%d`;
        chomp $cleanup_date;
        my $cleanup_dir = "/tmp/cleanup/";
        if ( !-d $cleanup_dir ) {
            mkdir $cleanup_dir;
        }
        my $cleanup = $cleanup_dir . $cleanup_date;
        exit if -e $cleanup;
        for ( ( "undo", "swap", "backup" ) ) {
            my $vim_dir = "$home/.vim/$_/";
            if ( -d $vim_dir ) {
                system("find $vim_dir -type f -mtime +1 -exec rm {} \\;");
            }
        }
        my $history_dir = "$history_root$cleanup_date";
        system("mkdir -p $history_dir");
        system("rsync -ar $home/.mozilla/ $history_dir/mozilla");
        system("cp .bash_history $history_dir/bash_history");
        my $cnt = 0;
        for my $cleanup (`ls $history_root | sort -r`) {
            $cnt++;
            system("rm -rf $history_root$cleanup") if ( $cnt > 3 );
        }
        system("touch $cleanup");
    }
    elsif ( $command eq "wiki" ) {
        my $wiki = "$home/.cache/wiki/";
        my $hash = "${wiki}hash";
        my $prev = $hash . ".prev";
        my $note = "$home/store/personal/mirror/notebook";
        system("mkdir -p $wiki");
        system("find $note -type f -exec md5sum {} \\; > $hash");
        if ( -e $prev ) {
            exit 0 if ( system("diff -u $prev $hash") == 0 );
        }
        system("mv $hash $prev");
        system("zim --export $note --output $wiki/notebook/ --overwrite --index-page index");
    }
    exit;
}

my $cnt = 1;
while (1) {
    system("status line");
    $cnt++;
    if ( $cnt >= 5 ) {
        system("status notify &");
        system("status mail &");
        system("status cleanup &");
        system("status wiki &");
        $cnt = 0;
    }
    sleep 5;
}
