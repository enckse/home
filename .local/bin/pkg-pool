#!/bin/bash
if [ -z "$1" ]; then
    echo "no input file given"
    exit 1
fi
if [ ! -e "$1" ]; then
    echo "$1 does not exist"
    exit 1
fi
echo "$1" | grep -q "\.deb$"
if [ $? -ne 0 ]; then
    echo "unknown file type"
    exit 1
fi
if [ -z "$2" ]; then
    echo "target repo required"
    exit 1
fi
if [ ! -d "$2" ]; then
    echo "$2 is not a valid target"
    exit 1
fi
if [ $(ls $2 | grep "\.deb$" | wc -l) -eq 0 ]; then
    echo "$2 is not a repository"
    exit 1
fi
bname=$(basename $1)
for f in $(ls $2); do
    cname=$(basename $f)
    if [[ "$cname" == "$bname" ]]; then
        echo "$bname is already deployed to $2"
        exit 1
    fi
done

name=$(echo $bname | cut -d "_" -f 1)
prevs=$(ls $2 | grep "$name\_")
if [ ! -z "$prevs" ]; then
    echo "previous versions exist"
    echo "$prevs" | sed "s/^/  -> /g"
    read
fi

for f in $(ls $2*.deb); do
    bname=$(basename $f)
    if cat $2/manifest | grep -q ":$bname"; then
        continue
    fi
    echo "$f is not in a manifest (will be deleted next time)"
    mv $f $f.prev
done

rm -f $2/*.prev
cp $1 $2/
