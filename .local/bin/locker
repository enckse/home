#!/usr/bin/perl
use strict;
use warnings;

my $tmpdir  = "/tmp/locker/";
my $no_zzz  = $tmpdir . "nozzz";
my $no_lock = $tmpdir . "nolock";

if ( !-d $tmpdir ) {
    mkdir $tmpdir;
}

sub do_lock {
    if ( -e $no_lock ) {
        return;
    }
    return if system("pgrep -x i3lock > /dev/null") == 0;
    system("brightness low");
    system("sleep 0.1");

    system("i3lock -c 333333");
    my $mode  = shift @_;
    my $count = 0;
    # 5 minutes
    my $timeout = 300;
    my $charge = `status charging`;
    if ( $charge eq "+" ) {
        # 4 hours
        $timeout = $timeout * 48;
    }
    if ( $mode == 1 ) {
        $count = $timeout + 1;
    }
    while (1) {
        last if ( system("pgrep -x i3lock > /dev/null") != 0 );
        sleep 1;
        $count++;
        if ( !-e $no_zzz ) {
            if ( $count > $timeout ) {
                system("volume reset");
                system("status sleep");
                system("pkill $_") for ( ( "vlc" ) );
                system("systemctl suspend");
                $count = 0;
            }
        }
    }

    system("brightness middle");
    system("xset -display :0 dpms force on");
}

my $command = "lock";
$command = shift @ARGV if (@ARGV);

if ( $command eq "lock" ) {
    do_lock(0);
}
elsif ( $command eq "sleep" ) {
    do_lock(1);
}
elsif ( $command eq "status" ) {
    if ( -e $no_zzz ) {
        print "NO_SLEEP";
    }
    elsif ( -e $no_lock ) {
        print "UNLOCKED";
    }
}
elsif ( $command eq "toggle" ) {
    system("pkill status");
    if ( -e $no_zzz ) {
        unlink $no_zzz;
    }
    else {
        if ( -e $no_lock ) {
            unlink $no_lock;
            system("touch $no_zzz");
        }
        else {
            system("touch $no_lock");
        }
    }
}

