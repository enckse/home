#!/bin/bash
source $HOME/.config/home/common
INDEX_DIR=$MAIL_DIR/Indexed/
INDEXED=${INDEX_DIR}cur/
INDEX_FILE=$USER_TMP/mail.index
ACCOUNTS="fastmail gmail"
LAST_MAILS=$USER_TMP/mail.last
PREV_MAILS=${LAST_MAILS}.prev

subcmd="$1"
if [ -z "$subcmd" ]; then
    python3 $HOME_BIN/email.py
    exit
fi
case "$subcmd" in
    "client")
        python3 $HOME_BIN/email.py client $2
        ;;
    "search")
        python3 $HOME_BIN/email.py search ${@:2}
        ;;
    "connected")
        python3 $HOME_BIN/email.py
        p=$(pidof mutt)
        while [ ! -z "$p" ]; do
            sleep 1
            p=$(pidof mutt)
            for d in $(echo "$ACCOUNTS"); do
                find ${MAIL_DIR}$d -type f | sort >> $LAST_MAILS
            done
            if [ -e $PREV_MAILS ]; then
                diff -u $PREV_MAILS $LAST_MAILS > /dev/null
                if [ $? -ne 0 ]; then
                    echo "mailbox changed"
                    python3 $HOME_BIN/email.py client $2
                fi
            fi
            mv $LAST_MAILS $PREV_MAILS
        done
        ;;
    "count")
        python3 $HOME_BIN/email.py count
        ;;
    *)
        echo "unknown command: $1"
        ;;
esac
