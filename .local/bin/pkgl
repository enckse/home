#!/bin/bash

_archpkg() {
    perl ~/.local/lib/archpkg.pl
}

_binrel() {
    perl ~/.local/lib/binrel.pl $@
}

_repoadd() {
    local files had cmd f d cwd
    cwd=$PWD
    if [ -z "$cwd/$1" ]; then
        echo "no package given..."
        exit 1
    fi
    cp $PWD/$1 ~/store/managed/pacman/$1
    cd ~/store/managed/pacman/
    repo-add enckse.db.tar.gz $1
    files=$(tar -tf enckse.db.tar.gz | cut -d "/" -f 1 | sort -u)
    had=0
    cmd=""
    for f in $(ls *.tar.xz); do
        d=0
        f=$(basename $f)
        for t in $files; do
            if [[ "$f" == "$t-x86_64.pkg.tar.xz" ]]; then
                d=1
            fi
        done
        if [ $d -eq 0 ]; then
            had=1
            cmd="$cmd $f"
            echo " -> $f"
        fi
    done
    if [ $had -eq 1 ]; then
        had="N"
        read -p "purge files (y/N)? " had
        if [[ "$had" == "y" ]]; then
            for f in $cmd; do
                rm $f
            done
        fi
    fi
    cd $cwd
}

_localbin() {
    perl ~/.local/lib/localbin.pl $@
}

mode="$1"
if [ -z "$mode" ]; then
    echo "no command given"
    exit 1
fi

case "$mode" in
    "arch")
        _archpkg
        ;;
    "binrel")
        _binrel "${@:2}"
        ;;
    "localbin")
        _localbin "${@:2}"
        ;;
    "repoadd")
        _repoadd "${@:2}"
        ;;
    "help")
        echo "arch binrel localbin repoadd"
        ;;
    *)
        echo "unknown command: $mode"
        ;;
esac
