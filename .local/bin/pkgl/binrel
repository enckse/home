#!/bin/bash
MODE=$1
if [ -z "$MODE" ]; then
    echo "no mode given"
    exit 1
fi
MODE=~/store/managed/binaries/$MODE/
_html() {
    echo "<html>
<body>
<pre>
binaries
===

Simple hosted pre-built binaries of personal projects.

1. download &lt;file&gt;.tar.gz
2. compare sha256 hash
3. tar xf &lt;file&gt;.tar.gz
4. ./configure
5. follow the prompts
<pre>
<hr /><pre>"
    for f in $(ls $MODE*.tar.gz); do
        echo "<code>$(sha256sum $f | cut -d " " -f 1)</code> <a href='$(basename $f)'>$(basename $f)</a>"
    done
    echo "</pre><small>last updated: $(date +%Y-%m-%d)</small></body></html>"
}

purge=""
for f in $(find $MODE -type f -name "*.tar.gz" -exec basename {} \; | cut -d "." -f 1 | sort -u); do
    echo "accounting: $(basename $f)"
    count=0
    for d in $(find ${MODE} | grep "$f\." | sort -u -r); do
        if [ $count -ge 3 ]; then
            purge="$purge $d"
            echo " -> remove $(basename $d)"
        fi
        count=$((count+1))
    done
done

if [ ! -z "$purge" ]; then
    read -p "purge (y/N)? " yes
    if [[ "$yes" == "y" ]]; then
        rm -f $purge
    fi
fi

_html > $MODE/index.html
targets="voidedtech.com"
if [[ "$1" == "internal" ]]; then
    targets="$targets fact"
fi
for t in $targets; do
    rsync -av --delete-after $MODE $t:/opt/binaries/$1/
done
