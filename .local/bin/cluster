#!/usr/bin/perl
use strict;
use warnings;

my @nodes  = ( 0, 1, 2, 3, 4, 5, 7 );
my $script = "~/.local/bin/cluster";
my $arg    = "start";

my %mapping;
$mapping{"productivity"} = 1;
$mapping{"webutils"}     = 2;
$mapping{"irc"}          = 3;
$mapping{"armdev"}       = 7;

if (@ARGV) {
    $arg = shift @ARGV;
}

if ( exists( $mapping{$arg} ) ) {
    system("$script ssh $mapping{$arg}");
    exit 0;
}

if ( $arg eq "start" or $arg eq "run" ) {
    my $cmds = join( " ", @ARGV );
    system(
"kitty --detach --start-as=maximized --title=cluster -- $script attach $cmds"
    );
}
elsif ( $arg eq "attach" ) {
    system("kitty @ goto-layout grid");
    my $cmds = join( " ", @ARGV );
    for my $node (@nodes) {
        system(
            "kitty @ launch --keep-focus $script ssh $node $cmds > /dev/null");
    }
    system("kitty @ close-window");
}
elsif ( $arg eq "productivity" ) {
    system("$script ssh 1");
}
elsif ( $arg eq "webutils" ) {
    system("$script ssh 2");
}
elsif ( $arg eq "ssh" ) {
    my $node = shift @ARGV;
    my $cmd  = join( " ", @ARGV );
    if ($cmd) {
        $cmd = "-- $cmd";
    }
    system("source ~/.variables && ssh cluster$node.voidedtech.com $cmd");
    if ($cmd) {
        print("\n\n\n");
        system('read -p "ENTER to exit"');
    }
}
elsif ( $arg eq "help" ) {
    my @apps = keys %mapping;
    print "run start " . join( " ", @apps );
}
