#!/bin/bash
if [ -z "$1" ]; then
    echo "requires one or more input files"
    exit 1
fi
if [ -z "$2" ]; then
    echo "requires an output file"
    exit 1
fi
idx=1
output="${@: -1}"
echo "output: $output.pdf"
tmpdir=$(mktemp -d)/
defaultcss=slides.css
if [ ! -e "$defaultcss" ]; then
    echo "creating default css"
    echo "body { 
    padding-left: 0.5in;
    padding-right: 0.5in;
    padding-top: 0.5in;
    padding-bottom: 0.5in;
    font-size: 32px;
    line-height: 1.5;
    font-family: Arial, Helvetica, sans-serif;
}
h1 { 
    text-align: center;
    font-size: 48px;
}" > $defaultcss
fi
logfile=${tmpdir}log.txt
_exit() {
    echo "failed!"
    cp $logfile log.txt
    exit 1
}
touch $logfile
for f in "$@"; do
    if [[ "$f" == "$output" ]]; then
        continue
    fi
    if echo $f | grep -q "\.md"; then
        echo "converting: $f"
        file=$tmpdir$idx.html
        echo "<html><head><style>" > $file
        cat $defaultcss >> $file
        echo "</style></head><body>" >> $file
        echo "<div id='slide-$idx'>" >> $file
        epiphyte-markdown -file $f >> $file
        if [ $? -ne 0 ]; then
            _exit
        fi
        echo "</div></body></html>" >> $file
        echo "$file" >> $logfile
        cat $file >> $logfile
    else
        echo "$f is not a markdown file"
        exit 1
    fi
    idx=$((idx+1))
done
echo 'creating pdfs...'
idx=1
for f in $(find $tmpdir -type f -name "*.html"); do
    file=$tmpdir$idx.pdf
    echo "making: $file"
    cat $f | wkhtmltopdf -O landscape - $file >> $logfile 2>&1
    if [ $? -ne 0 ]; then
        _exit
    fi
    idx=$((idx+1))
done

echo "merging pdfs..."
pdfs=$(find $tmpdir -type f -name "*.pdf")
pdfunite $pdfs $output.pdf
if [ $? -ne 0 ]; then
    _exit
fi
cp $logfile output.log
rm -rf $tmpdir
