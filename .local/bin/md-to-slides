#!/bin/bash
output="output"
echo "output: $output.pdf"
tmpdir=$(mktemp -d)/
defaultcss=slides.css
if [ ! -e "$defaultcss" ]; then
    echo "creating default css"
    echo "body { 
    padding-left: 0.5in;
    padding-right: 0.5in;
    padding-top: 0.5in;
    padding-bottom: 0.5in;
    font-size: 32px;
    line-height: 1.5;
    font-family: Arial, Helvetica, sans-serif;
}
h1 { 
    text-align: center;
    font-size: 48px;
}" > $defaultcss
fi
logfile=${tmpdir}log.txt
_exit() {
    cp $logfile output.log
    if [ -z "$1" ]; then
        echo "failed!"
        exit 1
    fi
}
touch $logfile
idx=1
for f in $(ls *.md | sort); do
    echo "converting: $f"
    file=$tmpdir$idx.html
    echo "<html><head><style>" > $file
    cat $defaultcss >> $file
    echo "</style></head><body>" >> $file
    echo "<div id='slide-$idx'>" >> $file
    cat $f | markdown >> $file
    if [ $? -ne 0 ]; then
        _exit
    fi
    echo "</div></body></html>" >> $file
    echo "$file" >> $logfile
    cat $file >> $logfile
    idx=$((idx+1))
done
if [ $idx -eq 1 ]; then
    echo "no markdown files found..."
    _exit
fi
echo 'creating pdfs...'
idx=1
for f in $(find $tmpdir -type f -name "*.html"); do
    file=$tmpdir$idx.pdf
    echo "making: $file"
    cat $f | wkhtmltopdf -O landscape - $file >> $logfile 2>&1
    if [ $? -ne 0 ]; then
        _exit
    fi
    idx=$((idx+1))
done

echo "merging pdfs..."
pdfs=$(find $tmpdir -type f -name "*.pdf")
pdfunite $pdfs $output.pdf
if [ $? -ne 0 ]; then
    _exit
fi
_exit "success"
rm -rf $tmpdir
