#!/usr/bin/perl
use strict;
use warnings;
use autodie;

my $cmd;
if (@ARGV) {
    $cmd = shift @ARGV;
}

die "no command" if !$cmd;

if ( $cmd eq "mail" ) {
    if ( -d $ENV{"HOME"} . "/store/imap" ) {
        exit 0 if system("pgrep -x mbsync > /dev/null") == 0;
        my $mbsync = "/tmp/mbsync";
        mkdir $mbsync if ( !-d $mbsync );
        system("notify-send -t 5000 'syncing mail'");
        for ( ( "mbsync -a", "notmuch new" ) ) {
            system("$_ | systemd-cat -t 'mbsync'");
        }
    }
}
elsif ( $cmd eq "mouse" ) {
    my $host =
      system('source ~/.variables && cat $HOST_TYPE | grep -q "$DESKTOP"');
    if ( $host != 0 ) {
        exit 0;
    }
    my $position =
      `xdotool getmouselocation | cut -d ':' -f 2 | cut -d ' ' -f 1` + 0;
    chomp $position;
    system("xdotool search . behave %@ mouse-enter windowfocus &");
    system("sleep 0.1");
    if ( $position > 1440 ) {
        system("xdotool mousemove 720 1000");
    }
    else {
        system("xdotool mousemove 2000 720");
    }
    system("pkill xdotool");
    print $position, "\n";
}
elsif ( $cmd eq "lock" or $cmd eq "suspend" or $cmd eq "xautolock" ) {
    my $suspend = 0;
    if ( $cmd eq "suspend" or $cmd eq "xautolock" ) {
        $suspend = 1;
    }
    if ($suspend) {
        my $host =
          system('source ~/.variables && cat $HOST_TYPE | grep -q "$LAPTOP"');
        if ( $host != 0 ) {
            if ( $cmd eq "suspend" ) {
                exit 0;
            }
            $suspend = 0;
        }
    }

    system("i3lock -c 333333");
    if ($suspend) {
        system("sleep 0.1");
        system("systemctl suspend");
    }
}
elsif ( $cmd eq "status" ) {
    system("perl ~/.local/bin/status.pl");
}
elsif ( $cmd eq "autoclip" ) {
    system("source ~/.variables && pass -c autoclip > /dev/null");
}
elsif ( $cmd eq "history" ) {
    my $hist = "/tmp/history";
    my $bash = "~/.bash_history";
    open( my $fh, '>', $hist );
    for (`cat $bash | sort -u`) {
        chomp;
        my $found = 0;
        for my $exe (
            (
                "cd", "vim", "git",   "rm",  "cp", "mv",
                "ls", "cat", "mkdir", "man", "firefox"
            )
          )
        {
            if ( $_ =~ m/^$exe / ) {
                $found = 1;
                last;
            }
        }
        next if ( $found == 1 );
        print $fh $_, "\n";
    }
    system("mv $hist $bash");
}
elsif ( $cmd eq "online" ) {
    my $exit =
      system("ping -c1 -w5 voidedtech.com > /dev/null 2>&1") == 0 ? 0 : 1;
    exit $exit;
}
else {
    print "unknown command";
}
