#!/usr/bin/perl
use strict;
use warnings;
use autodie;

my $light_reset    = "rebright";
my $light_brighter = "brighter";
my $light_dimmer   = "dimmer";
my $light_dim      = "dim";
my $light_bright   = "bright";

sub current_brightness {
    my $value =
`xrandr --current --verbose | grep Brightness | cut -d ":" -f 2 | head -n 1 | awk '{ print \$1 * 100 }'`;
    chomp $value;
    return 0 + $value;
}

my $cmd;
if (@ARGV) {
    $cmd = shift @ARGV;
}

die "no command" if !$cmd;

if ( $cmd eq "mail" ) {
    if ( -d $ENV{"HOME"} . "/store/personal/imap" ) {
        exit 0 if system("pgrep -x mbsync > /dev/null") == 0;
        my $mbsync = "/tmp/mbsync";
        mkdir $mbsync if ( !-d $mbsync );
        for ( ( "mbsync -a", "notmuch new" ) ) {
            system("$_ | systemd-cat -t 'mbsync'");
        }
    }
}
elsif ( $cmd eq "autoclip" ) {
    system(
"source ~/store/personal/config/etc/private.exports && PASSWORD_STORE_DIR=/home/enck/.pass/personal pass -c \$AUTOCLIP > /dev/null"
    );
}
elsif ( $cmd eq "history" ) {
    my $hist = "/tmp/history";
    my $bash = "~/.bash_history";
    open( my $fh, '>', $hist );
    for (`cat $bash | sort -u`) {
        chomp;
        my $found = 0;
        for my $exe (
            (
                "cd", "vim", "git",   "rm",  "cp", "mv",
                "ls", "cat", "mkdir", "man", "firefox"
            )
          )
        {
            if ( $_ =~ m/^$exe / ) {
                $found = 1;
                last;
            }
        }
        next if ( $found == 1 );
        print $fh $_, "\n";
    }
    system("mv $hist $bash");
}
elsif ( $cmd eq "brightness" ) {
    print current_brightness;
}
elsif ( $cmd eq "browser" ) {
    my $target = shift @ARGV;
    my $error = "no target";
    if ( $target ) {
        $error = "browser not available";
        my $browser = $ENV{"BROWSER"};
        my $pgrep = `pgrep -f $browser`;
        chomp $pgrep;
        if ( $pgrep ) {
            system("$browser $target");
            $error = "";
        }
    }
    if ( $error ) {
        print "unable to open system browser: $error\n";
        exit 1;
    }
}
elsif ($cmd eq "$light_reset"
    or $cmd eq "$light_brighter"
    or $cmd eq "$light_dimmer"
    or $cmd eq "$light_dim"
    or $cmd eq "$light_bright" )
{
    if ( $cmd eq "$light_brighter" or $cmd eq "$light_dimmer" ) {
        my $cur  = current_brightness;
        my $mode = "$light_reset";
        if ( $cmd eq "$light_brighter" ) {
            $mode = "$light_bright" if $cur >= 50;
        }
        else {
            $mode = "$light_dim" if $cur <= 95;
        }
        system("sys $mode");
        exit 0;
    }
    my $value = "0.9";
    $value = "0.3" if ( $cmd eq "$light_dim" );
    $value = "1.0" if ( $cmd eq "$light_bright" );

    for ( (`xrandr | grep " connected" | cut -d " " -f 1`) ) {
        chomp;
        system("xrandr --output $_ --brightness $value");
    }
}
else {
    print "unknown command";
}
