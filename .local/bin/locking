#!/usr/bin/perl

my $can_sleep = 1;
if ( $ENV{"IS_DESKTOP"} ) {
    $can_sleep = 0;
}

if (@ARGV) {
    $cmd = shift @ARGV;
}

if ( $cmd eq "lock" ) {
    system("xautolock -locknow");
}
elsif ( $cmd eq "sleep" ) {
    system("xautolock -locknow");
    if ( $can_sleep == 1 ) {
        system("sleep 1");
        system("status sleep");
        system("sys volume-reset");
        system("systemctl suspend");
    }
}

if ($cmd) {
    exit 0;
}

my $was_locked = 0;
while (1) {
    if ( system("pgrep xautolock > /dev/null") != 0 ) {
        system('xautolock -time 15 -locker "i3lock -c 333333"');
    }
    if ( system("pgrep i3lock > /dev/null") == 0 ) {
        if ( $was_locked == 0 ) {
            print "locking enabled\n";
            system("sys dim");
        }
        $was_locked = 1;
    }
    else {
        if ( $was_locked == 1 ) {
            system("sys rebright");
            system("xset -display :0 dpms force on");
        }
        $was_locked = 0;
    }
    system("sleep 0.1");
}
