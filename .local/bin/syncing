#!/bin/bash
source $HOME/.config/home/common
source $PRIV_CONF
COMMON_STORE=/mnt/Storage/Active/
INBOX_PATH=${COMMON_STORE}Inbox/
PROFILE_PATH=${COMMON_STORE}Drop/Profiles
SPACING="    "
TODAY=$(date +%Y-%m-%d-%p)
ARCHIVE=${USER_TMP}profile.$TODAY.tar.gz
BACKUP=${USER_TMP}profile.backup.$TODAY
GIT_SYNC=${USER_TMP}git.sync
GIT_PREV=${GIT_SYNC}.prev
READY="ready"
IS_CONNECTED=1
NOT_CONNECTED=0
RSYNC_MAIL=${USER_TMP}rsync.mail.

test-ssh() {
    local running
    running=$(ssh -o BatchMode=yes -o ConnectTimeout=5 $1 echo $READY 2>&1)
    if [[ "$running" == "$READY" ]]; then
        echo $IS_CONNECTED
    else
        echo $NOT_CONNECTED
    fi
}

_dobackup() {
    if [ -e "$BACKUP" ]; then
        echo 0
    else
        echo 1
    fi
}

_backup() {
    echo "daily backup"
    if [ ! -e $ARCHIVE ]; then
        echo "archiving"
        tar zcf $ARCHIVE $HOME/.mozilla/ &>/dev/null
        echo "archive completed: $?"
    fi
    echo "${SPACING}pushing profile out"
    scp $ARCHIVE $BASE_SERVER:$PROFILE_PATH/
    ssh $BASE_SERVER "find $PROFILE_PATH -type f -mtime +7 -exec rm {} \;"
    rm -f $ARCHIVE
    for f in $(ls $PERSONAL_LOC | grep "@"); do
        local h p d
        h=${RSYNC_MAIL}$f
        p=${h}.prev
        d=0
        if echo $f | grep -v -q localhost; then
            find ${PERSONAL_LOC}/$f -type f | sort > $h
            if [ -e "$p" ]; then
                diff -u $h $p > /dev/null
                if [ $? -eq 0 ]; then
                    echo "no change to $f"
                    d=1
                fi
            fi
            mv $h $p
        fi
        echo "backing up $f ($d)"
        if [ $d -eq 0 ]; then
            echo "syncing $f"
            rsync -vacr --delete-after $PERSONAL_LOC/$f/ $BASE_SERVER:${INBOX_PATH}/$f/ | sed "s/^/    /g"
        fi
    done
    touch $BACKUP
}

_dogit() {
    local d changes
    echo "git" > $GIT_SYNC
    for d in $(echo "$@"); do
        git -C "$d" log --pretty=format:'%h' -n 1 >> $GIT_SYNC
        echo ": $d" >> $GIT_SYNC
    done
    changes=1
    if [ -e "$GIT_PREV" ]; then
        touch $GIT_PREV
        diff -u $GIT_PREV $GIT_SYNC > /dev/null
        if [ $? -eq 0 ]; then
            changes=0
        fi
    fi
    echo $changes
}

_gitpush() {
    local d
    echo "syncing..."
    for d in $(echo "$@"); do
        echo "$d"
        git -C "$d" push 2>&1 | sed "s/^/$SPACING/g"
    done
    if [ -e $GIT_SYNC ]; then
        mv $GIT_SYNC $GIT_PREV
    fi
}

_sendzips() {
    local f hashed prev last bname
    echo "sending zips..."
    for f in $(echo "$@" | tr ' ' '\n' | grep -v "$HOME_STORE"); do
        bname=$(basename $f)
        prev=$USER_TMP$bname.ziphash
        hashed=$(git -C $f rev-parse HEAD)
        echo "checking zip status: $f"
        zip=1
        if [ -e $prev ]; then
            last=$(cat $prev)
            if [[ "$last" == "$hashed" ]]; then
                zip=0
            fi
        fi
        if [ $zip -eq 1 ]; then
            echo "zipping..."
            local stime
            stime=$(date +%s)
            local fname
            fname=${USER_TMP}$bname.$TODAY-$stime.mail
            local zname
            zname="$fname.7z"
            7z a -p$ZIP_PASS $zname $f/ > /dev/null
            local subj
            subj="automated: zips ($bname) $TODAY"
            mpack -s "$subj" -o $fname $zname
            cat $fname | python3 $HOME_BIN/inject_mail.py --subject "$subj" --address $ZIP_MAIL --maildir ${MAIL_DIR}fastmail/Filtered/Automated/
            rm -f $zname
            rm -f $fname
        fi
        echo "$hashed" > $prev
    done
}

sync-now() {
    echo "syncing"
    local dirs pushgit pushbackup
    ${HOME_BIN}/email
    dirs="${PRIV_PATH} ${HOME_STORE} ${PERM_PASS}/personal"
    pushgit=$(_dogit "$dirs" | tail -n 1)
    pushbackup=$(_dobackup | tail -n 1)
    echo "status (git: $pushgit, archive: $pushbackup)"
    _sendzips "$dirs"
    if [ $pushgit -eq 0 ]; then
        if [ $pushbackup -eq 0 ]; then
            return
        fi
    fi
    auth=$(cat $SSH_AUTH_TMP)
    export SSH_AUTH_SOCK=$auth
    available=$(test-ssh $BASE_SERVER)
    echo "====================="
    echo "running "$(date +%Y-%m-%dT%H:%M:%S)
    echo "====================="
    echo "checked for connection...$available"
    if [ $available -eq $IS_CONNECTED ]; then
        if [ -e $SSH_AUTH_TMP ]; then
            if [ $pushgit -eq 1 ]; then
                _gitpush "$dirs"
            fi
            if [ $pushbackup -eq 1 ]; then
                _backup
            fi
            echo "local sync completed"
            touch $LAST_SYNC
        else
            echo "ssh agent unavailable"
        fi
    fi
}

last=0
mutt=0
while [ 1 -eq 1 ]; do
    curr=$(date +%s)
    min=$(date +%M)
    if [ $min -eq 0 -o $last -eq 0 ]; then
        last=$curr
    fi
    delta=$((curr-last))
    if [ $delta -gt 1200 ]; then
        last=$curr
        network=$(wsw --mode current)
        echo $network | grep -q -E "$NET_SYNC"
        if [ $? -eq 0 ]; then
            sync-now >> ${USER_TMP}sync.$TODAY
        fi
    fi
    pidof mutt > /dev/null
    if [ $? -eq 0 ]; then
        if [ $mutt -eq 0 ]; then
            mutt=1
        fi
    else
        if [ $mutt -eq 1 ]; then
            mutt=0
            ${HOME_BIN}/email
        fi
    fi
    sleep 1
done
