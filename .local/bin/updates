#!/usr/bin/python3
import common
import argparse
import os
import tempfile

_SCRIPTS = "https://www.weechat.org/files/scripts/"


def _weechat(env):
    """Synchronize weechat."""
    import urllib.request
    for a in ["autosort", "buffer_autoset"]:
        print("pulling: " + a)
        p = a + ".py"
        output = os.path.join(env.HOME, ".weechat/python/" + p)
        urllib.request.urlretrieve(_SCRIPTS + p, output)


def _music(env):
    """Synchronize music."""
    import subprocess
    music_file = os.path.join(env.PERM_CONFIGS, "music")
    includes = []
    chars = []
    with open(music_file, 'r') as f:
        for l in f:
            strip = l.strip()
            c = strip[0] + "/"
            if c not in chars:
                includes.append(c)
                chars.append(c)
            includes.append(c + strip + "/***")
    with tempfile.NamedTemporaryFile() as tmp:
        for l in includes:
            tmp.write((l + "\n").encode("UTF-8"))
        tmp.flush()
        subprocess.call(["rsync",
                         "-av",
                         "--include-from",
                         tmp.name,
                         '--exclude',
                         '*',
                         env.BASE_SERVER + ":store/Home/Media/Music/",
                         os.path.join(env.HOME_CACHE, "music"),
                         "--delete-after",
                         "--delete-excluded"])


def main():
    """Program entry."""
    parser = argparse.ArgumentParser()
    parser.add_argument("command")
    args = parser.parse_args()
    env = common.read_env()
    if args.command == "weechat":
        _weechat(env)
    elif args.command == "music":
        _music(env)
    else:
        print("unknown command")


if __name__ == "__main__":
    main()
