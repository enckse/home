#!/usr/bin/perl
use strict;
use warnings;
use autodie;
use Text::CSV;
use URI::Escape;

my @dmenu_cmd = ("dmenu");
push @dmenu_cmd, @ARGV;

my $browser   = "/usr/bin/firefox-developer-edition";
my $fastmail  = "fastmail";
my $passwords = "passwords";

my @apps = ( "smplayer", "pavucontrol" );

push @apps, $fastmail;
push @apps, $passwords;

my $csv = Text::CSV->new( { sep_char => ',' } );
open( my $data, '<', "/home/enck/store/personal/config/etc/urls.csv" );
my %available;
while ( my $line = <$data> ) {
    chomp $line;
    if ( $csv->parse($line) ) {
        my @fields = $csv->fields();
        my $arg    = $fields[2];
        chomp $arg;
        my @args = split / /, $arg;
        unshift @args, $browser;
        push @args, $fields[1];
        $available{ $fields[0] } = join " ", @args;
    }
}

foreach my $app (@apps) {
    $available{$app} = $app;
}

my $cmd = "echo '";
keys %available;
foreach my $opt ( keys %available ) {
    $cmd = "$cmd$opt\n";
}

chomp $cmd;
$cmd = "$cmd' | sort | " . join " ", @dmenu_cmd;
$cmd =~ s/#/\\#/g;
my $stdout = `$cmd`;
chomp $stdout;
if ( $stdout eq "" ) {
    exit;
}

my @localcmd = ();
if ( $stdout eq $fastmail ) {
    @localcmd = (
        "kitty", "--title=$stdout", "mutt", "-F",
        "/home/enck/.mutt/fastmail.muttrc"
    );
}

if ( $stdout eq $passwords ) {
    @localcmd = (
        "keepassxc", "/home/enck/store/personal/private/confidential/passwords"
    );
}

my $length = @localcmd;
if ( $length > 0 ) {
    system( "cd /home/enck/downloads && " . join " ", @localcmd );
    exit;
}

if ( exists( $available{$stdout} ) ) {
    system( $available{$stdout} );
    exit;
}

$stdout =~ s/^search //;
my $uri = " https://www.duckduckgo.com/?q=" . uri_escape($stdout);
system( $browser . $uri );
