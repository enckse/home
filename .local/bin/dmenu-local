#!/usr/bin/perl
use strict;
use warnings;
use autodie;
use Text::CSV;
use URI::Escape;
use String::ShellQuote;

my $browser   = "/usr/bin/chromium";
my $fastmail  = "fastmail";
my $passwords = "passwords";

my %available;
foreach my $app ( "vlc", "pavucontrol", $fastmail, $passwords, "mumble" ) {
    $available{$app} = $app;
}

my $csv = Text::CSV->new( { sep_char => ',' } );
open my $DATA, '<', '/home/enck/store/personal/config/etc/urls.csv';
while (<$DATA>) {
    chomp;
    if ( $csv->parse($_) ) {
        my @fields = $csv->fields();
        my $arg    = $fields[2];
        chomp $arg;
        my @args = split / /, $arg;
        push @args, $fields[1];
        $available{ $fields[0] } = $browser . " " . shell_quote @args;
    }
}

my $cmd = "echo '";
keys %available;
foreach my $opt ( keys %available ) {
    $cmd = "$cmd$opt\n";
}

chomp $cmd;
$cmd = "$cmd' | sort | dmenu " . shell_quote @ARGV;
my $stdout = `$cmd`;
chomp $stdout;
if ( $stdout eq "" ) {
    exit;
}

if ( $stdout eq $fastmail ) {
    my @localcmd = (
        "kitty", "--title=$stdout", "mutt", "-F",
        "/home/enck/.mutt/fastmail.muttrc"
    );
    system( "cd /home/enck/downloads && " . shell_quote @localcmd );
    exit;
}

if ( $stdout eq $passwords ) {
    system( "keepassxc",
        "/home/enck/store/personal/private/confidential/passwords" );
    exit;
}

if ( exists( $available{$stdout} ) ) {
    system( $available{$stdout} );
    exit;
}

$stdout =~ s/^search //i;
my $uri = " https://www.duckduckgo.com/?q=" . uri_escape($stdout);
system( $browser . $uri );
