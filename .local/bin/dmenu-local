#!/usr/bin/python3
"""dmenu wrapper."""
import sys
import os
import csv
import subprocess
import urllib.parse


_SEARCH = "search"
_BROWSER = "/usr/bin/firefox-developer-edition"
_FASTMUTT = "fastmail"
_PASSWORDS = "passwords"
_TASKS = "tasks"
_LOCALS = [_FASTMUTT, _PASSWORDS, _TASKS]
_APPS = ["smplayer", "pavucontrol"] + _LOCALS


def _local(cmd):
    """Run a local command."""
    cwd = "/home/enck/downloads"
    command = ["kitty",
               "--title={}".format(cmd),
               "mutt",
               "-F",
               "/home/enck/.mutt/fastmail.muttrc"]
    if cmd == _PASSWORDS:
        command = ["keepassxc", "/home/enck/store/personal/private/confidential/passwords"]
    elif cmd == _TASKS:
        command[-1] = "/home/enck/.mutt/tasks.muttrc"
    subprocess.call(command, cwd=cwd)


def _dmenu(args):
    """dmenu backing call."""
    urls = "/home/enck/store/personal/config/etc/urls.csv"
    available = {}
    dmenu_cmd = ["dmenu"] + args
    with open(urls, 'r') as f:
        reader = csv.reader(f)
        for r in reader:
            name = r[0]
            url = r[1]
            args = r[2].split(" ")
            args = [x for x in args if x]
            available[name] = [_BROWSER] + args + [url]
    for a in _APPS:
        available[a] = a
    p = subprocess.Popen(dmenu_cmd,
                         stdin=subprocess.PIPE, stdout=subprocess.PIPE)
    options = sorted(available.keys())
    stdout, err = p.communicate(input=("\n".join(options)).encode("utf-8"))
    if err is not None:
        return
    result = stdout.decode("utf-8").strip()
    if result in options:
        cmd = result.lower()
        if cmd in _LOCALS:
            _local(cmd)
        else:
            c = available[cmd]
            subprocess.call(c)
    else:
        if "." in result and " " not in result:
            subprocess.call([_BROWSER, result])
            return
        if not result:
            return
        search(_BROWSER, result)


def main():
    """Program entry."""
    args = []
    if len(sys.argv) > 1:
        args = sys.argv[1:]
    _dmenu(args)


def search(browser, term):
    if term.startswith(_SEARCH):
        term = term[len(_SEARCH):]
    query = {}
    query["q"] = term
    params = urllib.parse.urlencode(query)
    subprocess.call([browser,
                     "https://www.duckduckgo.com/?{}".format(params)])


if __name__ == "__main__":
    main()
