#!/bin/bash
source $HOME/.config/home/common
NETWORKS=${HOME_STORE}networks/
LIST="list"
ADAPTERS="wlp58s0 enp0s31f6"
CACHED=/tmp/network

_networks() {
    for f in $(find $NETWORKS -type f); do
        basename $f
    done
}

_iplink() {
    sudo ip link set $1 $2
    echo "settings $1 -> $2"
}

_change() {
    local filename
    filename="$NETWORKS$1"
    if [ ! -e "$filename" ]; then
        echo "$1 is not valid"
        exit 1
    fi
    if [ -z "$1" ]; then
        echo "no file given"
        exit 1
    fi
    echo "$1" > $CACHED
    for a in $(echo "$ADAPTER"); do
        ip link set $a "down"
    done
    sudo pkill wpa_supplicant
    device=$(echo "$1" | cut -d "." -f 2)
    flags=""
    echo "$1" | grep -q "^wired."
    if [ $? -eq 0 ]; then
        flags="-D wired"
    fi
    _iplink $device up
    sudo /bin/bash -c "/sbin/wpa_supplicant -B -c $filename -i $device $flags"
}

cmd=$1
if [ -z "$cmd" ]; then
    echo "no command given"
    exit 1
else
    case "$cmd" in
        "$LIST")
            _networks
            exit 0
            ;;
        "reload")
            if [ -e "$CACHED" ]; then
                cmd=$(cat $CACHED)
            else
                echo "no cached profile"
                exit 1
            fi
            ;;
    esac
    _change $cmd
fi
