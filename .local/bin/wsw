#!/usr/bin/perl
use strict;
use warnings;

my $wsw       = "/home/enck/.cache/wsw";
my $storage   = "/home/enck/store/personal/config/etc/wsw/";
my $interface = "";
my $profile   = "";
my $driver    = "";
my $config    = "$storage";

if (@ARGV) {
    my $cmd = shift @ARGV;
    if ( $cmd eq "help" ) {
        print "addr online status list reload change";
    }
    elsif ( $cmd eq "addr" ) {
        print
`ip -4 -o address | cut -d " " -f 2,7 | grep -v "lo 127.0.0.1" | cut -d "/" -f 1 | sed "s/ /:/g" | tr '\\n' ',' | sed 's/^/[/g;s/\$/]/g;s/,]/]/g'`;
    }
    elsif ( $cmd eq "daemon" ) {
        print "starting wsw daemon\n";
        my @stats = stat $wsw;
        while (1) {
            system("$wsw") if -e "$wsw";
            sleep 1;
            print "reloading\n";
        }
    }
    elsif ( $cmd eq "online" ) {
        my $exit =
          system("ping -c1 -w5 voidedtech.com > /dev/null 2>&1") == 0 ? 0 : 1;
        exit $exit;
    }
    elsif ( $cmd eq "status" ) {
        if ( -e $wsw ) {
            print
              `cat $wsw | head -n 2  | tail -n 1 | grep "^#" | cut -d " " -f 2`;
        }
        else {
            print "none\n";
        }
    }
    elsif ( $cmd eq "list" ) {
        print $_ for ( split( / /, `ls $storage` ) );
    }
    elsif ( $cmd eq "reload" ) {
        system("touch $wsw") if -e $wsw;
    }
    elsif ( $cmd eq "change" ) {
        my $ask = shift @ARGV;
        $config .= $ask;
        if ( -e $config ) {
            $interface =
              `cat $config | head -n 1 | grep "^#" | cut -d " " -f 2`;
            chomp $interface;
            if ($interface) {
                $driver = "-D wired" if ( $interface =~ /^e/ );
                $config = ""         if ( `cat $config | wc -l` < 2 );
                $profile = $ask;
            }
        }
    }
}

exit unless $profile;

my $script = "#!/bin/bash\n# $profile\n";
$script .= "interface=\"" . $interface . "\"\n";
$script .= "config=\"" . $config . "\"\n";
$script .= "driver=\"" . $driver . "\"\n";
$script .= "_status() {
    stat $wsw  | grep Modify | cut -d \" \" -f 3
}";

$script .= '
interfaces=$(ip addr | grep "^[1-9]" | cut -d ":" -f 2 | sed "s/\s*//g" | grep -v "^lo$")

matched=0
for i in $(echo $interfaces); do
    if [[ "$interface" == "$i" ]]; then
        matched=1
        break
    fi
done

if [ $matched -eq 0 ]; then
    echo "$interface not found/available"
    exit 1
fi

stats=$(_status)

echo "releasing"
dhclient -r
sleep 3

echo "killing daemons"
pkill dhclient
pkill wpa_supplicant

echo "setting interfaces down"
for i in $(echo $interfaces); do
    echo "-> interface: $i"
    ip link set $i down
done

echo "setting interface up"
ip link set $interface up
if [ ! -z "$config" ]; then
    echo "starting supplicant"
    wpa_supplicant -B -i$interface -c $config $driver &
fi

sleep 3
echo "starting dhclient"
dhclient $interface

current=$(_status)
while [ 1 -eq 1 ]; do
    current=$(_status)
    if [[ "$current" != "$stats" ]]; then
        exit 0
    fi
    sleep 5
done
';

system("echo '$script' > $wsw");
chmod 0755, $wsw;
