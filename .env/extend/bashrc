#!/bin/bash

if [ -d "$HOME/.gnupg" ]; then
    unset SSH_AGENT_PID
    if [ "${gnupg_SSH_AUTH_SOCK_by:-0}" -ne $$ ]; then
        export SSH_AUTH_SOCK="$(gpgconf --list-dirs agent-ssh-socket)"
    fi

    export GPG_TTY=$(tty)
    gpg-connect-agent updatestartuptty /bye >/dev/null
else
    echo "no .gnupg dir"
fi

if [ ! -e /var/lib/systemd/linger/enck ]; then
    echo "sudo loginctl enable-linger"
fi

MUTT=$HOME/.mutt
if [ -d $MUTT ]; then
    if [ -e $START_MUTT ]; then
        rm -f $START_MUTT
        mutt -F $HOME/.mutt/fastmail.muttrc
        exit 0
    fi

    git -C .mutt/ status -sb
else
    echo "no .mutt folder"
fi

export GOPATH="$HOME/.cache/go"

if [ ! -z "$SCHROOT_CHROOT_NAME" ]; then
    PS1='[\u@${SCHROOT_CHROOT_NAME} \W]\$ '
fi

pltidy() {
    local f
    for f in $(git grep "#\!/usr/bin/perl" | cut -d ":" -f 1 | sort); do
       perltidy $f
       mv $f.tdy $f
    done
}

glint() {
    local f
    goimports -l . | grep -v bindata.go | sed 's/^/[goimports]    /g'
    revive ./... | sed 's/^/[revive]       /g'
    for f in $(find . -type f -name "*.go" -exec dirname {} \; | sort -u); do
        go vet $f | sed 's/^/[govet]        /g'
    done
}

setup-user-env() {
    local is_setup
    is_setup=~/.cache/env.setup
    if [ ! -e $is_setup ]; then
        ln -sf /etc/voidedtech/skel/vimrc ~/.vimrc
        ln -sf ~/.env/extend/env.d/gitconfig ~/.gitconfig
        ln -sf ~/.env/extend/env.d/drudge.conf ~/.drudge.conf
        touch $is_setup
    fi
}

setup-user-env
